"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[196],{55067:function(e,t,i){i.d(t,{Z:function(){return v}});var r=i(37762),a=i(15671),n=i(43144),s=i(11752),l=i(61120),o=i(60136),u=i(29388),c=i(93169),h=i(80613),d=i(64510),y=i(52424),f=i(40655),_=function(e,t){return e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col},v=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,a.Z)(this,i),(r=t.call(this))._tileInfoView=e,r}return(0,n.Z)(i,[{key:"requiresDedicatedFBO",get:function(){return!1}},{key:"renderChildren",value:function(e){this.sortChildren(_),this.setStencilReference(e),(0,s.Z)((0,l.Z)(i.prototype),"renderChildren",this).call(this,e)}},{key:"createRenderParams",value:function(e){var t=e.state,r=(0,s.Z)((0,l.Z)(i.prototype),"createRenderParams",this).call(this,e);return r.requiredLevel=this._tileInfoView.getClosestInfoForScale(t.scale).level,r.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(t.scale),r}},{key:"prepareRenderPasses",value:function(e){var t=this,r=(0,s.Z)((0,l.Z)(i.prototype),"prepareRenderPasses",this).call(this,e);return r.push(e.registerRenderPass({name:"stencil",brushes:[f.Z],drawPhase:h.jx.DEBUG|h.jx.MAP|h.jx.HIGHLIGHT,target:function(){return t.getStencilTarget()}})),(0,c.Z)("esri-tiles-debug")&&r.push(e.registerRenderPass({name:"tileInfo",brushes:[y.Z],drawPhase:h.jx.DEBUG,target:function(){return t.children}})),r}},{key:"getStencilTarget",value:function(){return this.children}},{key:"setStencilReference",value:function(e){var t,i=1,a=(0,r.Z)(this.children);try{for(a.s();!(t=a.n()).done;){t.value.stencilRef=i++}}catch(n){a.e(n)}finally{a.f()}}}]),i}(d.Z)},10196:function(e,t,i){i.r(t),i.d(t,{default:function(){return ye}});var r=i(74165),a=i(15861),n=i(29439),s=i(37762),l=i(15671),o=i(43144),u=i(11752),c=i(61120),h=i(60136),d=i(29388),y=i(27366),f=i(52639),_=i(84652),v=i(32718),p=i(92026),g=i(66978),m=i(94172),C=i(49861),T=(i(25243),i(69912)),b=i(48732),k=i(65156),w=i(92975),S=i(10106),R=i(98067),Z=i(16054),D=i(48790),E=i(73828),I=function(e,t){return e+1/(1<<2*t)},P=function(){function e(t,i){(0,l.Z)(this,e),this._tiles=new Map,this._tileCache=new Z.Z(40,(function(e){return e.dispose()})),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=i}return(0,o.Z)(e,[{key:"destroy",value:function(){var e,t=(0,s.Z)(this._tiles);try{for(t.s();!(e=t.n()).done;){var i=(0,n.Z)(e.value,2);i[0];i[1].dispose()}}catch(r){t.e(r)}finally{t.f()}this._tiles=null,this._tileCache.clear(),this._tileCache=null}},{key:"update",value:function(e){this._updateCacheSize(e);var t,i=this.tileInfoView,r=i.getTileCoverage(e.state,0,"smallest"),a=r.spans,l=r.lodInfo,o=l.level,u=this._tiles,c=new Set,h=new Set,d=(0,s.Z)(a);try{for(d.s();!(t=d.n()).done;)for(var y=t.value,f=y.row,_=y.colFrom,v=y.colTo,p=_;p<=v;p++){var g=E.Z.getId(o,f,l.normalizeCol(p),l.getWorldForColumn(p)),m=this._getOrAcquireTile(g);c.add(g),m.processed()?this._addToContainer(m):h.add(new E.Z(g))}}catch(O){d.e(O)}finally{d.f()}var C,T=(0,s.Z)(u);try{for(T.s();!(C=T.n()).done;){var b=(0,n.Z)(C.value,2),k=b[0];b[1].isCoverage=c.has(k)}}catch(O){T.e(O)}finally{T.f()}var w,S=(0,s.Z)(h);try{for(S.s();!(w=S.n()).done;){var R=w.value;this._findPlaceholdersForMissingTiles(R,c)}}catch(O){S.e(O)}finally{S.f()}var Z,I=!1,P=(0,s.Z)(u);try{for(P.s();!(Z=P.n()).done;){var x=(0,n.Z)(Z.value,2),L=x[0],H=x[1];H.neededForCoverage=c.has(L),H.neededForCoverage||H.isHoldingForFade&&i.intersects(r,H.key)&&c.add(L),H.isFading&&(I=!0)}}catch(O){P.e(O)}finally{P.f()}var A,M=(0,s.Z)(this._tiles);try{for(M.s();!(A=M.n()).done;){var F=(0,n.Z)(A.value,2),U=F[0];F[1];c.has(U)||this._releaseTile(U)}}catch(O){M.e(O)}finally{M.f()}return D.Z.pool.release(r),!I}},{key:"clear",value:function(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}},{key:"clearCache",value:function(){this._tileCache.clear()}},{key:"_findPlaceholdersForMissingTiles",value:function(e,t){var i,r=[],a=(0,s.Z)(this._tiles);try{for(a.s();!(i=a.n()).done;){var l=(0,n.Z)(i.value,2),o=(l[0],l[1]);this._addPlaceholderChild(r,o,e,t)}}catch(c){a.e(c)}finally{a.f()}var u=r.reduce(I,0);Math.abs(1-u)<1e-6||this._addPlaceholderParent(e.id,t)}},{key:"_addPlaceholderChild",value:function(e,t,i,r){t.key.level<=i.level||!t.hasData()||function(e,t){var i=t.level-e.level;return e.row===t.row>>i&&e.col===t.col>>i&&e.world===t.world}(i,t.key)&&(this._addToContainer(t),r.add(t.id),e.push(t.key.level-i.level))}},{key:"_addPlaceholderParent",value:function(e,t){for(var i=this._tiles,r=e;;){if(!(r=x(r))||t.has(r))return;var a=i.get(r);if(a&&a.hasData())return this._addToContainer(a),void t.add(a.id)}}},{key:"_getOrAcquireTile",value:function(e){var t=this._tiles.get(e);return t||((t=this._tileCache.pop(e))||(t=this.acquireTile(new E.Z(e))),this._tiles.set(e,t),t)}},{key:"_releaseTile",value:function(e){var t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}},{key:"_addToContainer",value:function(e){var t,i=[],r=this._container;if(!r.contains(e)){var a,l=this._visibleTiles,o=(0,s.Z)(l);try{for(o.s();!(a=o.n()).done;){var u=(0,n.Z)(a.value,2),c=(u[0],u[1]);this._canConnectDirectly(e,c)&&i.push(c),(0,p.Wi)(t)&&this._canConnectDirectly(c,e)&&(t=c)}}catch(g){o.e(g)}finally{o.f()}if((0,p.pC)(t)){var h,d=(0,s.Z)(i);try{for(d.s();!(h=d.n()).done;){var y=h.value;t.childrenTiles.delete(y),e.childrenTiles.add(y),y.parentTile=e}}catch(g){d.e(g)}finally{d.f()}t.childrenTiles.add(e),e.parentTile=t}else{var f,_=(0,s.Z)(i);try{for(_.s();!(f=_.n()).done;){var v=f.value;e.childrenTiles.add(v),v.parentTile=e}}catch(g){_.e(g)}finally{_.f()}}l.set(e.id,e),r.addChild(e)}}},{key:"_removeFromContainer",value:function(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),(0,p.pC)(e.parentTile)){e.parentTile.childrenTiles.delete(e);var t,i=(0,s.Z)(e.childrenTiles);try{for(i.s();!(t=i.n()).done;){var r=t.value;(0,p.pC)(e.parentTile)&&e.parentTile.childrenTiles.add(r)}}catch(l){i.e(l)}finally{i.f()}}var a,n=(0,s.Z)(e.childrenTiles);try{for(n.s();!(a=n.n()).done;){a.value.parentTile=e.parentTile}}catch(l){n.e(l)}finally{n.f()}e.parentTile=null,e.childrenTiles.clear()}},{key:"_canConnectDirectly",value:function(e,t){for(var i=e.key,r=t.key,a=r.level,n=r.row,s=r.col,l=r.world,o=this._visibleTiles;a>0;){if(a--,n>>=1,s>>=1,i.level===a&&i.row===n&&i.col===s&&i.world===l)return!0;if(o.has("".concat(a,"/").concat(n,"/").concat(s,"/").concat(l)))return!1}return!1}},{key:"_updateCacheSize",value:function(e){var t=e.state.size;if(t[0]!==this._viewSize[0]||t[1]!==this._viewSize[1]){var i=Math.ceil(t[0]/512)+1,r=Math.ceil(t[1]/512)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*i*r}}}]),e}();function x(e){var t=e.split("/"),i=(0,n.Z)(t,4),r=i[0],a=i[1],s=i[2],l=i[3],o=parseInt(r,10);return 0===o?null:"".concat(o-1,"/").concat(parseInt(a,10)>>1,"/").concat(parseInt(s,10)>>1,"/").concat(parseInt(l,10))}var L=i(72291),H=i(1413),A=i(91505),M=i(46618),F=i(38684),U=i(42121),O=i(12463),z=i(36210),B=i(50127),N=i(21391),V=1e-6,q=function(e){(0,h.Z)(i,e);var t=(0,d.Z)(i);function i(e,r){var a;return(0,l.Z)(this,i),(a=t.call(this)).styleRepository=e,a._tileToHandle=new Map,a._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},a._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},a._completed=!1,a._symbolRepository=new z.L(4096,r,(function(){return new F.J})),a._symbolDeclutterer=new O.g(r,a._symbolRepository,(function(e,t,i){return new U.f(e,t,i,a.styleRepository,a._zoom,a._viewState.rotation)}),(function(e,t){e.allSymbolsFadingOut=!0,e.lastOpacityUpdate=t,(0,B.C$)(e,t,!0),e.decluttered=!0,e.requestRender()}),(function(e,t){return a.styleRepository.getStyleLayerByUID(e.styleLayerUID).z-a.styleRepository.getStyleLayerByUID(t.styleLayerUID).z}),(function(e){var t=a.styleRepository.getStyleLayerByUID(e);if(a._zoom+V<t.minzoom||a._zoom-V>=t.maxzoom)return!1;var i=t.getLayoutProperty("visibility");return!i||i.getValue()!==N.EE.NONE})),a}return(0,o.Z)(i,[{key:"addTile",value:function(e){var t=this;e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",(function(){t._symbolRepository.add(e),t.restartDeclutter()}))),this._symbolRepository.add(e),this.restartDeclutter()}},{key:"removeTile",value:function(e){var t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}},{key:"update",value:function(e,t){return this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]},this._continueDeclutter(),this._completed}},{key:"restartDeclutter",value:function(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}},{key:"clear",value:function(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach((function(e){return e.remove()})),this._tileToHandle.clear()}},{key:"stale",get:function(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}},{key:"deleteStyleLayers",value:function(e){this._symbolRepository.deleteStyleLayers(e)}},{key:"_continueDeclutter",value:function(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(M.Ts),this._completed&&this._scheduleNotifyStable())}},{key:"_scheduleNotifyStable",value:function(){var e=this;(0,p.pC)(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout((function(){e._stableNotificationHandle=null,e.emit("fade-complete")}),1.5*M.nN)}},{key:"_notifyUnstable",value:function(){(0,p.pC)(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}]),i}(A.Z),Q=i(80613),G=i(23588),j=function(e){(0,h.Z)(i,e);var t=(0,d.Z)(i);function i(){return(0,l.Z)(this,i),t.apply(this,arguments)}return(0,o.Z)(i,[{key:"_createTransforms",value:function(){return{dvs:(0,G.c)(),tileMat3:(0,G.c)()}}}]),i}(i(72900).I),Y=i(55067),W=i(8548),K=1e-6;function J(e,t){if(e){var i=e.getLayoutProperty("visibility");if(!i||i.getValue()!==N.EE.NONE&&(void 0===e.minzoom||e.minzoom<t+K)&&(void 0===e.maxzoom||e.maxzoom>=t-K))return!0}return!1}var X=function(e){(0,h.Z)(i,e);var t=(0,d.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this,e))._backgroundTiles=[],r._pointToCallbacks=new Map,r}return(0,o.Z)(i,[{key:"destroy",value:function(){var e,t;this.removeAllChildren(),null!==(e=this._spriteMosaic)&&void 0!==e&&e.dispose(),this._spriteMosaic=null,null!==(t=this._glyphMosaic)&&void 0!==t&&t.dispose(),this._glyphMosaic=null,(0,p.pC)(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}},{key:"setStyleResources",value:function(e,t,i){var r=this;if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=i,(0,p.Wi)(this._symbolFader)){var a=new q(this._styleRepository,this.children);a.on("fade-start",(function(){r.emit("fade-start"),r.requestRender()})),a.on("fade-complete",(function(){r.emit("fade-complete"),r.requestRender()})),this._symbolFader=a}(0,p.Wg)(this._symbolFader).styleRepository=i}},{key:"setSpriteMosaic",value:function(e){var t;null!==(t=this._spriteMosaic)&&void 0!==t&&t.dispose(),this._spriteMosaic=e}},{key:"deleteStyleLayers",value:function(e){(0,p.pC)(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)}},{key:"hitTest",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=(0,g.hh)(),e.abrupt("return",(this._pointToCallbacks.set(t,i),this.requestRender(),i.promise));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"enterTileInvalidation",value:function(){var e,t=(0,s.Z)(this.children);try{for(t.s();!(e=t.n()).done;){e.value.invalidating=!0}}catch(i){t.e(i)}finally{t.f()}}},{key:"createRenderParams",value:function(e){return(0,H.Z)((0,H.Z)({},(0,u.Z)((0,c.Z)(i.prototype),"createRenderParams",this).call(this,e)),{},{renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos})}},{key:"doRender",value:function(e){!this.visible||e.drawPhase!==Q.jx.MAP&&e.drawPhase!==Q.jx.DEBUG||void 0===this._spriteMosaic||(0,u.Z)((0,c.Z)(i.prototype),"doRender",this).call(this,e)}},{key:"addChild",value:function(e){return(0,u.Z)((0,c.Z)(i.prototype),"addChild",this).call(this,e),(0,p.pC)(this._symbolFader)?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}},{key:"removeChild",value:function(e){return(0,p.pC)(this._symbolFader)&&this._symbolFader.removeTile(e),this.requestRender(),(0,u.Z)((0,c.Z)(i.prototype),"removeChild",this).call(this,e)}},{key:"renderChildren",value:function(e){var t=e.drawPhase;if(t!==Q.jx.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){e.drawPhase=Q.jx.HITTEST;var r=e.painter.effects.hittestVTL;r.bind(e),this._doRender(e),r.draw(e,this._pointToCallbacks),r.unbind(e),e.drawPhase=t}}else(0,u.Z)((0,c.Z)(i.prototype),"renderChildren",this).call(this,e)}},{key:"removeAllChildren",value:function(){for(var e=0;e<this.children.length;e++){var t=this.children[e];(0,p.pC)(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}(0,u.Z)((0,c.Z)(i.prototype),"removeAllChildren",this).call(this)}},{key:"getStencilTarget",value:function(){return this.children.filter((function(e){return e.neededForCoverage&&e.hasData()}))}},{key:"restartDeclutter",value:function(){(0,p.pC)(this._symbolFader)&&this._symbolFader.restartDeclutter()}},{key:"_doRender",value:function(e){var t=e.context,r=this._styleRepository;if(r){var a=r.layers,n=!0;e.drawPhase===Q.jx.HITTEST&&(n=!1),r.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,r.backgroundBucketIds)),(0,u.Z)((0,c.Z)(i.prototype),"renderChildren",this).call(this,e),e.drawPhase===Q.jx.MAP&&this._fade(e.displayLevel,e.state);var l=this.children.filter((function(e){return e.visible&&e.hasData()}));if(!l||0===l.length)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);var o,h=(0,s.Z)(l);try{for(h.s();!(o=h.n()).done;){o.value.triangleCount=0}}catch(f){h.e(f)}finally{h.f()}t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(W.xS.KEEP,W.xS.KEEP,W.xS.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(W.wb.LEQUAL),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(var d=a.length-1;d>=0;d--)this._renderStyleLayer(a[d],e,l);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(n),t.setBlendFunctionSeparate(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA,W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(var y=0;y<a.length;y++)this._renderStyleLayer(a[y],e,l);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0)}}},{key:"_fade",value:function(e,t){(0,p.pC)(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())}},{key:"_renderStyleLayer",value:function(e,t,i){var r=t.painter,a=t.renderPass;if(void 0!==e){var n=e.getLayoutProperty("visibility");if(!n||n.getValue()!==N.EE.NONE){var l;switch(e.type){case N.fR.BACKGROUND:return;case N.fR.FILL:if("opaque"!==a&&"translucent"!==t.renderPass)return;l="vtlFill";break;case N.fR.LINE:if("translucent"!==a)return;l="vtlLine";break;case N.fR.CIRCLE:if("translucent"!==a)return;l="vtlCircle";break;case N.fR.SYMBOL:if("translucent"!==a)return;l="vtlSymbol"}if(i=e.type===N.fR.SYMBOL?i.filter((function(e){return e.decluttered})):i.filter((function(e){return e.neededForCoverage})),"vtlSymbol"!==l){var o=t.displayLevel;if(0===i.length||void 0!==e.minzoom&&e.minzoom>=o+K||void 0!==e.maxzoom&&e.maxzoom<o-K)return}var u=e.uid;t.styleLayerUID=u,t.styleLayer=e;var c,h=(0,s.Z)(i);try{for(h.s();!(c=h.n()).done;){if(c.value.layerData.has(u)){r.renderObjects(t,i,l);break}}}catch(d){h.e(d)}finally{h.f()}}}}},{key:"_renderBackgroundLayers",value:function(e,t){var i,r=e.context,a=e.displayLevel,n=e.painter,l=e.state,o=this._styleRepository,u=!1,c=(0,s.Z)(t);try{for(c.s();!(i=c.n()).done;){var h=i.value;if(o.getLayerById(h).type===N.fR.BACKGROUND&&J(o.getLayerById(h),a)){u=!0;break}}}catch(B){c.e(B)}finally{c.f()}if(u){var d=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),y=d.spans,f=d.lodInfo,_=f.level,v=(0,k.Ue)(),g=[];if(this._renderPasses){var m=this._renderPasses[0];(0,p.pC)(this._clippingInfos)&&(m.brushes[0].prepareState(e),m.brushes[0].drawMany(e,this._clippingInfos))}var C,T,b=this._backgroundTiles,w=0,S=(0,s.Z)(y);try{for(S.s();!(T=S.n()).done;)for(var R=T.value,Z=R.row,I=R.colFrom,P=R.colTo,x=I;x<=P;x++){if(w<b.length)(C=b[w]).key.set(_,Z,f.normalizeCol(x),f.getWorldForColumn(x)),this._tileInfoView.getTileBounds(v,C.key,!1),C.x=v[0],C.y=v[3],C.resolution=this._tileInfoView.getTileResolution(_);else{var L=new E.Z(_,Z,f.normalizeCol(x),f.getWorldForColumn(x)),H=this._tileInfoView.getTileBounds((0,k.Ue)(),L),A=this._tileInfoView.getTileResolution(_);C=new j(L,A,H[0],H[3],512,512,4096,4096),b.push(C)}C.setTransform(l),g.push(C),w++}}catch(B){S.e(B)}finally{S.f()}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(W.xS.KEEP,W.xS.KEEP,W.xS.REPLACE),r.setStencilFunction(W.wb.EQUAL,0,255);var M=!0;e.drawPhase===Q.jx.HITTEST&&(M=!1),r.setStencilTestEnabled(M);var F,U=(0,s.Z)(t);try{for(U.s();!(F=U.n()).done;){var O=F.value,z=o.getLayerById(O);z.type===N.fR.BACKGROUND&&J(z,a)&&(e.styleLayerUID=z.uid,e.styleLayer=z,n.renderObjects(e,g,"vtlBackground"))}}catch(B){U.e(B)}finally{U.f()}D.Z.pool.release(d)}}}]),i}(Y.Z),$=i(30969),ee=i(95986),te=i(22753),ie=i(44070),re=(i(53634),i(63780),i(93169),i(37825),i(49800),i(3667),i(371),i(45412)),ae=i(87422),ne={geometry:[new(i(61109).G)("a_PositionAndFlags",3,W.g.SHORT,0,6)]},se=new Map;se.set("a_PositionAndFlags",0);var le={vsPath:"debug/overlay",fsPath:"debug/overlay",attributes:se},oe=function(e){(0,h.Z)(i,e);var t=(0,d.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this))._conf=e,r}return(0,o.Z)(i,[{key:"_createTransforms",value:function(){return{dvs:(0,G.c)()}}},{key:"doRender",value:function(e){this._updateTransforms(e),this._ensureResources(e);var t=e.context;t.useProgram(this._program),this._program.setUniformMatrix3fv("u_dvsMat3",this.transforms.dvs),this._program.setUniform4fv("u_colors",this._conf.getColors(e)),this._program.setUniform1fv("u_opacities",this._conf.getOpacities(e));var i=this._conf.getMesh(e),r=i.vertexData,a=i.indexData;this._vertexBuffer.setData(r),this._indexBuffer.setData(a),t.bindVAO(this._vertexArray),t.setBlendingEnabled(!0),t.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),t.setDepthTestEnabled(!1),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawElements(W.MX.TRIANGLES,a.length,W.g.UNSIGNED_INT,0)}},{key:"onDetach",value:function(){this._vertexArray=(0,p.M2)(this._vertexArray)}},{key:"_updateTransforms",value:function(e){(0,te.g)(this.transforms.dvs),(0,te.h)(this.transforms.dvs,this.transforms.dvs,[-1,1]),(0,te.d)(this.transforms.dvs,this.transforms.dvs,[2/e.state.size[0],-2/e.state.size[1],1])}},{key:"_ensureResources",value:function(e){var t=e.context;this._program||(this._program=e.painter.materialManager.getProgram(le)),this._vertexBuffer||(this._vertexBuffer=ie.f.createVertex(t,W.l1.STREAM_DRAW)),this._indexBuffer||(this._indexBuffer=ie.f.createIndex(t,W.l1.STREAM_DRAW)),this._vertexArray||(this._vertexArray=new re.U(t,se,ne,{geometry:this._vertexBuffer},this._indexBuffer))}}],[{key:"makeFlags",value:function(e,t){return e|t<<2}}]),i}(ae.s),ue=i(75572),ce=i(32344),he=i(67581),de=function(e){(0,h.Z)(i,e);var t=(0,d.Z)(i);function i(){var e;return(0,l.Z)(this,i),(e=t.apply(this,arguments))._styleChanges=[],e._fetchQueue=null,e._parseQueue=null,e._tileHandlerPromise=null,e._isTileHandlerReady=!1,e._collisionOverlay=null,e.fading=!1,e._getCollidersMesh=function(t){var i,r=t.state.pixelRatio,a=0,l=[],o=[],u=(0,s.Z)(e._vectorTileContainer.children);try{for(u.s();!(i=u.n()).done;){var c=i.value;if(c.symbols){var h,d=(0,s.Z)(c.symbols);try{for(d.s();!(h=d.n()).done;){var y,f=(0,n.Z)(h.value,2),_=(f[0],f[1]),v=(0,s.Z)(_);try{for(v.s();!(y=v.n()).done;){var p,g=y.value,m=(0,s.Z)(g.colliders);try{for(m.s();!(p=m.n()).done;){var C=p.value,T=(C.xScreen+C.dxScreen)*r,b=(C.yScreen+C.dyScreen)*r,k=C.width*r,w=C.height*r,S=g.unique.parts[C.partIndex].targetOpacity>.5;if(S||"all"===e.layer.showCollisionBoxes){var R=S?2:0,Z=S?3:0,D=oe.makeFlags(R,Z);l.push(T,b,D,T+k,b,D,T,b+w,D,T+k,b+w,D),o.push(a+0,a+1,a+2,a+1,a+3,a+2),a+=4;var E=S?3:1,I=S?3:0,P=oe.makeFlags(E,I);l.push(T,b,P,T+k,b,P,T,b+1,P,T+k,b+1,P),o.push(a+0,a+1,a+2,a+1,a+3,a+2),a+=4,l.push(T,b+w-1,P,T+k,b+w-1,P,T,b+w,P,T+k,b+w,P),o.push(a+0,a+1,a+2,a+1,a+3,a+2),a+=4,l.push(T,b,P,T+1,b,P,T,b+w,P,T+1,b+w,P),o.push(a+0,a+1,a+2,a+1,a+3,a+2),a+=4,l.push(T+k-1,b,P,T+k,b,P,T+k-1,b+w,P,T+k,b+w,P),o.push(a+0,a+1,a+2,a+1,a+3,a+2),a+=4}}}catch(x){m.e(x)}finally{m.f()}}}catch(x){v.e(x)}finally{v.f()}}}catch(x){d.e(x)}finally{d.f()}}}}catch(x){u.e(x)}finally{u.f()}return{vertexData:new Int16Array(l),indexData:new Uint32Array(o)}},e._getCollidersColors=function(){return[1,.5,0,1,1,0,0,1,0,1,.5,1,0,.5,0,1]},e._getCollidersOpacities=function(){return[.05,.01,.15,.2]},e}return(0,o.Z)(i,[{key:"hitTest",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,i){var a,n,s,l,o;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._tileHandlerPromise){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,this._tileHandlerPromise;case 4:return e.next=6,this._vectorTileContainer.hitTest(i);case 6:if((a=e.sent)&&0!==a.length){e.next=9;break}return e.abrupt("return",null);case 9:if(n=a[0]-1,s=this._styleRepository,l=s.getStyleLayerByUID(n)){e.next=12;break}return e.abrupt("return",null);case 12:return o=s.getStyleLayerIndex(l.id),e.abrupt("return",[{type:"graphic",mapPoint:t,layer:this.layer,graphic:new f.Z({attributes:{layerId:o,layerName:l.id,layerUID:n},layer:this.layer,sourceLayer:this.layer})}]);case 14:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"update",value:function(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=e.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}},{key:"attach",value:function(){var e=this,t=this.layer.currentStyleInfo.style;this._styleRepository=new $.Z(t),this._tileInfoView=new ue.Z(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new X(this._tileInfoView),this._tileHandler=new R.m(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this._vectorTileContainer.on("fade-start",(function(){e.fading=!0,e.notifyChange("updating"),e.requestUpdate()})),this._vectorTileContainer.on("fade-complete",(function(){var t;null!==(t=e._collisionOverlay)&&void 0!==t&&t.requestRender(),e.fading=!1,e.notifyChange("updating"),e.requestUpdate()})),(0,m.YP)((function(){return e.layer.showCollisionBoxes}),(function(t){"none"!==t?e._collisionOverlay||(e._collisionOverlay=new oe({getMesh:e._getCollidersMesh,getColors:e._getCollidersColors,getOpacities:e._getCollidersOpacities}),e.container.addChild(e._collisionOverlay)):e._collisionOverlay&&(e.container.removeChild(e._collisionOverlay),e._collisionOverlay=null),e.container.requestRender()}),m.nn),this.layer.on("paint-change",(function(t){if(t.isDataDriven)e._styleChanges.push({type:S.Fr.PAINTER_CHANGED,data:t}),e.notifyChange("updating"),e.requestUpdate();else{var i=e._styleRepository,r=i.getLayerById(t.layer);if(!r)return;var a=r.type===N.fR.SYMBOL;i.setPaintProperties(t.layer,t.paint),a&&e._vectorTileContainer.restartDeclutter(),e._vectorTileContainer.requestRender()}})),this.layer.on("layout-change",(function(t){var i=e._styleRepository,r=i.getLayerById(t.layer);if(r){var a=(0,b.Hg)(r.layout,t.layout);if(!(0,p.Wi)(a)){if((0,b.uD)(a,"visibility")&&1===function(e){if((0,p.Wi)(e))return 0;switch(e.type){case"partial":return Object.keys(e.diff).length;case"complete":return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case"collection":return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}(a))return i.setLayoutProperties(t.layer,t.layout),r.type===N.fR.SYMBOL&&e._vectorTileContainer.restartDeclutter(),void e._vectorTileContainer.requestRender();e._styleChanges.push({type:S.Fr.LAYOUT_CHANGED,data:t}),e.notifyChange("updating"),e.requestUpdate()}}})),this.layer.on("style-layer-visibility-change",(function(t){var i=e._styleRepository,r=i.getLayerById(t.layer);r&&(i.setStyleLayerVisibility(t.layer,t.visibility),r.type===N.fR.SYMBOL&&e._vectorTileContainer.restartDeclutter(),e._vectorTileContainer.requestRender())})),this.layer.on("style-layer-change",(function(t){e._styleChanges.push({type:S.Fr.LAYER_CHANGED,data:t}),e.notifyChange("updating"),e.requestUpdate()})),this.layer.on("delete-style-layer",(function(t){e._styleChanges.push({type:S.Fr.LAYER_REMOVED,data:t}),e.notifyChange("updating"),e.requestUpdate()})),this.layer.on("load-style",(function(){return e._loadStyle()})),this.layer.on("spriteSource-change",(function(t){e._newSpriteSource=t.spriteSource,e._styleChanges.push({type:S.Fr.SPRITES_CHANGED,data:null});var i,r=e._styleRepository.layers,a=(0,s.Z)(r);try{for(a.s();!(i=a.n()).done;){var n=i.value;switch(n.type){case N.fR.SYMBOL:n.getLayoutProperty("icon-image")&&e._styleChanges.push({type:S.Fr.LAYOUT_CHANGED,data:{layer:n.id,layout:n.layout}});break;case N.fR.LINE:n.getPaintProperty("line-pattern")&&e._styleChanges.push({type:S.Fr.PAINTER_CHANGED,data:{layer:n.id,paint:n.paint,isDataDriven:n.isPainterDataDriven()}});break;case N.fR.FILL:n.getLayoutProperty("fill-pattern")&&e._styleChanges.push({type:S.Fr.PAINTER_CHANGED,data:{layer:n.id,paint:n.paint,isDataDriven:n.isPainterDataDriven()}})}}}catch(l){a.e(l)}finally{a.f()}e.notifyChange("updating"),e.requestUpdate()}))])}},{key:"detach",value:function(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=(0,p.SC)(this._vectorTileContainer),this._tileHandler=(0,p.SC)(this._tileHandler)}},{key:"moveStart",value:function(){this.requestUpdate()}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"moveEnd",value:function(){this._collisionOverlay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate()}},{key:"supportsSpatialReference",value:function(e){var t;return(0,w.fS)(null===(t=this.layer.tileInfo)||void 0===t?void 0:t.spatialReference,e)}},{key:"canResume",value:function(){var e=(0,u.Z)((0,c.Z)(i.prototype),"canResume",this).call(this),t=this.layer.currentStyleInfo;if(e&&null!==t&&void 0!==t&&t.layerDefinition){var r=this.view.scale,a=t.layerDefinition,n=a.minScale,s=a.maxScale;t&&t.layerDefinition&&(n&&n<r&&(e=!1),s&&s>r&&(e=!1))}return e}},{key:"isUpdating",value:function(){var e=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||e.length>0&&e.some((function(e){return e.invalidating}))||this.fading}},{key:"acquireTile",value:function(e){var t,i=this,r=this._createVectorTile(e);return null!==(t=this._tileHandlerPromise)&&void 0!==t&&t.then((function(){i._fetchQueue.push(r.key).then((function(e){return i._parseQueue.push({key:r.key,data:e})})).then((function(e){r.once("attach",(function(){return i.requestUpdate()})),r.setData(e),i.requestUpdate(),i.notifyChange("updating")})).catch((function(e){i.notifyChange("updating"),(0,g.D_)(e)||v.Z.getLogger(i.declaredClass).error(e)}))})),r}},{key:"releaseTile",value:function(e){var t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}},{key:"_start",value:function(){var e=this;if(this._stop(),this._tileManager=new P({acquireTile:function(t){return e.acquireTile(t)},releaseTile:function(t){return e.releaseTile(t)},tileInfoView:this._tileInfoView},this._vectorTileContainer),this.layer.currentStyleInfo){var t=new AbortController,i=this._tileHandler.start({signal:t.signal}).then((function(){e._fetchQueue=new ce.Z({tileInfoView:e._tileInfoView,process:function(t,i){return e._getTileData(t,i)},concurrency:15}),e._parseQueue=new ce.Z({tileInfoView:e._tileInfoView,process:function(t,i){return e._parseTileData(t,i)},concurrency:8}),e.requestUpdate(),e._isTileHandlerReady=!0}));this._tileHandler.spriteMosaic.then((function(t){e._vectorTileContainer.setStyleResources(t,e._tileHandler.glyphMosaic,e._styleRepository),e.requestUpdate()})),this._tileHandlerAbortController=t,this._tileHandlerPromise=i}}},{key:"_stop",value:function(){if(this._tileHandlerAbortController&&this._vectorTileContainer){var e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=(0,p.SC)(this._fetchQueue),this._parseQueue=(0,p.SC)(this._parseQueue),this._tileManager=(0,p.SC)(this._tileManager),this._vectorTileContainer.removeAllChildren()}}},{key:"_getTileData",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,i){var a;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tileHandler.fetchTileData(t,i);case 2:return a=e.sent,e.abrupt("return",(this.notifyChange("updating"),a));case 4:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_parseTileData",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,i){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._tileHandler.parseTileData(t,i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_applyStyleChanges",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){var t,i,a,n,l,o,u,c,h,d,y,f,_=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache(),t=this._styleChanges,e.prev=2,e.next=5,this._tileHandler.updateStyle(t);case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),v.Z.getLogger(this.declaredClass).error("error applying vector-tiles style update",e.t0.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0;case 10:if(i=this._styleRepository,a=[],t.forEach((function(e){if(e.type===S.Fr.LAYER_REMOVED){var t=e.data,r=i.getLayerById(t.layer);r&&a.push(r.uid)}})),n=[],t.forEach((function(e){var t=e.type,r=e.data;switch(t){case S.Fr.PAINTER_CHANGED:i.setPaintProperties(r.layer,r.paint),l=r.layer;break;case S.Fr.LAYOUT_CHANGED:i.setLayoutProperties(r.layer,r.layout),l=r.layer;break;case S.Fr.LAYER_REMOVED:return void i.deleteStyleLayer(r.layer);case S.Fr.LAYER_CHANGED:i.setStyleLayer(r.layer,r.index),l=r.layer.id;break;case S.Fr.SPRITES_CHANGED:_._vectorTileContainer.setSpriteMosaic(_._tileHandler.setSpriteSource(_._newSpriteSource)),_._newSpriteSource=null,l=null}var a=i.getLayerById(l);a&&n.push(a.uid)})),o=this._vectorTileContainer.children,a.length>0){this._vectorTileContainer.deleteStyleLayers(a),u=(0,s.Z)(o);try{for(u.s();!(c=u.n()).done;)c.value.deleteLayerData(a)}catch(p){u.e(p)}finally{u.f()}}if(this._fetchQueue.resume(),this._parseQueue.resume(),!(n.length>0)){e.next=36;break}h=[],d=(0,s.Z)(o),e.prev=19,f=(0,r.Z)().mark((function e(){var t,i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=y.value,i=_._fetchQueue.push(t.key).then((function(e){return _._parseQueue.push({key:t.key,data:e,styleLayerUIDs:n})})).then((function(e){return t.setData(e)})),h.push(i);case 3:case"end":return e.stop()}}),e)})),d.s();case 22:if((y=d.n()).done){e.next=26;break}return e.delegateYield(f(),"t1",24);case 24:e.next=22;break;case 26:e.next=31;break;case 28:e.prev=28,e.t2=e.catch(19),d.e(e.t2);case 31:return e.prev=31,d.f(),e.finish(31);case 34:return e.next=36,Promise.all(h);case 36:this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate();case 37:case"end":return e.stop()}}),e,this,[[2,7],[19,28,31,34]])})));return function(){return e.apply(this,arguments)}}()},{key:"_loadStyle",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){var t,i,a,n;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.layer.currentStyleInfo.style,i=(0,_.d9)(t),this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new $.Z(i),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController,a=this._tileHandlerAbortController.signal,e.prev=3,this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,i),e.next=7,this._tileHandlerPromise;case 7:e.next=13;break;case 9:if(e.prev=9,e.t0=e.catch(3),(0,g.D_)(e.t0)){e.next=13;break}throw e.t0;case 13:if(!a.aborted){e.next=15;break}return e.abrupt("return",(this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate()));case 15:return e.next=17,this._tileHandler.spriteMosaic;case 17:n=e.sent,this._vectorTileContainer.setStyleResources(n,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate();case 19:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createVectorTile",value:function(e){var t=this._tileInfoView.getTileBounds((0,k.Ue)(),e),i=this._tileInfoView.getTileResolution(e.level);return new L.i(e,i,t[0],t[3],512,512,this._styleRepository)}}]),i}((0,ee.y)(he.Z));(0,y._)([(0,C.Cb)()],de.prototype,"_fetchQueue",void 0),(0,y._)([(0,C.Cb)()],de.prototype,"_parseQueue",void 0),(0,y._)([(0,C.Cb)()],de.prototype,"_isTileHandlerReady",void 0),(0,y._)([(0,C.Cb)()],de.prototype,"fading",void 0);var ye=de=(0,y._)([(0,T.j)("esri.views.2d.layers.VectorTileLayerView2D")],de)}}]);
//# sourceMappingURL=196.2fbb52ad.chunk.js.map