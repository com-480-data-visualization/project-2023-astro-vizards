"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[188],{23254:function(e,t,i){i.d(t,{a:function(){return d}});var r=i(37762),n=i(15671),a=i(43144),s=2654435761,u=2246822519,o=3266489917,l=668265263,c=374761393;function h(e){for(var t=[],i=0,r=e.length;i<r;i++){var n=e.charCodeAt(i);n<128?t.push(n):n<2048?t.push(192|n>>6,128|63&n):n<55296||n>=57344?t.push(224|n>>12,128|n>>6&63,128|63&n):(i++,n=65536+((1023&n)<<10|1023&e.charCodeAt(i)),t.push(240|n>>18,128|n>>12&63,128|n>>6&63,128|63&n))}return new Uint8Array(t)}var d=function(){function e(t){(0,n.Z)(this,e),this._seed=t,this._totallen=0,this._bufs=[],this.init()}return(0,a.Z)(e,[{key:"init",value:function(){return this._bufs=[],this._totallen=0,this}},{key:"updateFloatArray",value:function(e){var t,i=[],n=(0,r.Z)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;isNaN(a)?i.push("NaN"):a===1/0?i.push("Infinity"):a===-1/0?i.push("-Infinity"):0===a?i.push("0"):i.push(a.toString(16))}}catch(s){n.e(s)}finally{n.f()}this.update(h(i.join("")))}},{key:"updateIntArray",value:function(e){var t=Int32Array.from(e);this.update(new Uint8Array(t.buffer))}},{key:"updateUint8Array",value:function(e){this.update(Uint8Array.from(e))}},{key:"updateWithString",value:function(e){return this.update(h(e))}},{key:"update",value:function(e){return this._bufs.push(e),this._totallen+=e.length,this}},{key:"digest",value:function(){var e,t=new Uint8Array(this._totallen),i=0,n=(0,r.Z)(this._bufs);try{for(n.s();!(e=n.n()).done;){var a=e.value;t.set(a,i),i+=a.length}}catch(s){n.e(s)}finally{n.f()}return this.init(),this._xxHash32(t,this._seed)}},{key:"_xxHash32",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e,r=t+c&4294967295,n=0;if(i.length>=16){var a=[t+s+u&4294967295,t+u&4294967295,t+0&4294967295,t-s&4294967295],h=e,d=h.length-16,p=0;for(n=0;(4294967280&n)<=d;n+=4){var f=n,y=h[f+0]+(h[f+1]<<8),_=h[f+2]+(h[f+3]<<8),v=y*u+(_*u<<16),m=a[p]+v&4294967295,g=65535&(m=m<<13|m>>>19),b=m>>>16;a[p]=g*s+(b*s<<16)&4294967295,p=p+1&3}r=(a[0]<<1|a[0]>>>31)+(a[1]<<7|a[1]>>>25)+(a[2]<<12|a[2]>>>20)+(a[3]<<18|a[3]>>>14)&4294967295}r=r+e.length&4294967295;for(var F=e.length-4;n<=F;n+=4){var C=n,x=i[C+0]+(i[C+1]<<8),E=i[C+2]+(i[C+3]<<8);r=(65535&(r=(r=r+(x*o+(E*o<<16))&4294967295)<<17|r>>>15))*l+((r>>>16)*l<<16)&4294967295}for(;n<i.length;++n)r=(65535&(r=(r+=i[n]*c)<<11|r>>>21))*s+((r>>>16)*s<<16)&4294967295;return r=((65535&(r^=r>>>15))*u&4294967295)+((r>>>16)*u<<16),r=((65535&(r^=r>>>13))*o&4294967295)+((r>>>16)*o<<16),(r^=r>>>16)<0?r+4294967296:r}}]),e}()},23819:function(e,t,i){i.d(t,{H:function(){return p},b:function(){return d}});var r,n,a=i(30168),s=i(24967),u=i(64600),o=i(58406),l=i(98634),c=i(64201),h=i(19253);function d(e){var t=new c.kG;t.include(s.k),t.include(u.f);var i=e.usesHalfFloat;return t.fragment.uniforms.add([new h.A("densityMap",(function(e){return e.densityMap})),new h.A("tex",(function(e){return e.colorRamp})),new o.p("densityNormalizer",(function(e){return 1/(e.maxDensity-e.minDensity)})),new o.p("minDensity",(function(e){return e.minDensity}))]),t.fragment.uniforms.add(new o.p("densityMultiplier",(function(e){return 3/(e.searchRadius*e.searchRadius*Math.PI)}))),i&&t.constants.add("compressionFactor","float",4),t.fragment.code.add((0,l.H)(r||(r=(0,a.Z)(["\n    void main() {\n      float density = texture2D(densityMap, uv).r * densityMultiplier",";\n      float densityRatio = (density - minDensity) * densityNormalizer;\n\n      vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));\n\n      discardOrAdjustAlpha(color);\n      gl_FragColor = color;\n    }\n  "])),i?(0,l.H)(n||(n=(0,a.Z)([" * compressionFactor"]))):"")),t}var p=Object.freeze(Object.defineProperty({__proto__:null,build:d},Symbol.toStringTag,{value:"Module"}))},65322:function(e,t,i){i.d(t,{H:function(){return y},b:function(){return f}});var r,n,a,s,u,o=i(30168),l=i(41012),c=i(58406),h=i(98634),d=i(64201),p=i(4760);function f(e){var t=new d.kG,i=t.vertex,f=t.fragment;(0,l.Sv)(i,e);var y=e.isAttributeDriven,_=e.usesHalfFloat;return t.attributes.add(p.T.POSITION,"vec3"),t.attributes.add(p.T.UV0,"vec2"),y&&(t.attributes.add(p.T.FEATUREATTRIBUTE,"float"),t.varyings.add("attributeValue","float")),_&&t.constants.add("compressionFactor","float",.25),t.varyings.add("unitCirclePos","vec2"),i.uniforms.add(new c.p("radius",(function(e,t){var i=e.resolutionForScale,r=e.searchRadius,n=t.camera,a=t.screenToWorldRatio;return 2*r*(0===i?1:i/a)*n.pixelRatio/n.fullViewport[2]}))),i.code.add((0,h.H)(r||(r=(0,o.Z)(["\n    void main() {\n      unitCirclePos = uv0;\n\n      vec4 posProj = proj * (view * vec4(",", 1.0));\n      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);\n\n      ","\n      gl_Position = posProj + quadOffset;\n    }\n  "])),p.T.POSITION,y?(0,h.H)(n||(n=(0,o.Z)(["attributeValue = ",";"])),p.T.FEATUREATTRIBUTE):"")),f.code.add((0,h.H)(a||(a=(0,o.Z)(["\n    void main() {\n      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);\n      if (radiusRatioSquared > 1.0) {\n        discard;\n      }\n\n      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;\n      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared "," ",";\n      gl_FragColor = vec4(density);\n    }\n  "])),y?(0,h.H)(s||(s=(0,o.Z)([" * attributeValue"]))):"",_?(0,h.H)(u||(u=(0,o.Z)([" * compressionFactor"]))):"")),t}var y=Object.freeze(Object.defineProperty({__proto__:null,build:f},Symbol.toStringTag,{value:"Module"}))},5845:function(e,t,i){i.d(t,{g:function(){return G}});var r=i(37762),n=i(74165),a=i(15861),s=i(15671),u=i(43144),o=i(60136),l=i(29388),c=i(27366),h=i(85015),d=i(14921),p=i(80987),f=(i(93169),i(10064)),y=i(100),_=i(84652),v=i(32718),m=i(92026),g=i(67426),b=i(66978),F=i(94172),C=i(49861),x=(i(25243),i(69912)),E=i(61826),k=i(25899),T=i(37933),w=i(67387),R=i(33997),S=i(32080),Z=i(29439),O=i(52639),V=i(80885),D=i(43977),I=i(62554),P=i(1030),M=i(87037),A=i(62140),N=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]],U=function(){function e(t,i,r){(0,s.Z)(this,e),this._loadingGraphics=new Map,this._loadedGraphics=new Map,this._pendingGraphics=new Map,this._dataExtentGraphic=null,this._enabled=!0,this._tileFetcher=t,this._view=r,this._tilingScheme=new A.t(i),this._loadedSymbols=N.map((function(e){return new P.Z(new D.Z({material:{color:[e[0],e[1],e[2],.6]},outline:{color:"black",size:1}}))})),this._loadingSymbols=[new P.Z(new D.Z({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this._pendingSymbols=[new P.Z(new D.Z({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this._dataExtentSymbol=new P.Z(new D.Z({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}return(0,u.Z)(e,[{key:"destroy",value:function(){this.enabled=!1}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,this.update()}},{key:"update",value:function(){var e=this;this._enabled?(this._synchronizeMaps(this._loadingGraphics,{filter:function(e){return e.isFetching},symbols:this._loadingSymbols}),this._synchronizeMaps(this._loadedGraphics,{filter:function(e){return!e.isFetching},symbols:this._loadedSymbols}),this._synchronizeMaps(this._pendingGraphics,{filter:function(e){return!e.isFetching},symbols:this._pendingSymbols}),this.showDataExtent(this._tileFetcher.filterExtent)):(this._loadingGraphics.forEach((function(t){e._view.graphics.removeMany(t)})),this._loadingGraphics.clear(),this._loadedGraphics.forEach((function(t){e._view.graphics.removeMany(t)})),this._loadedGraphics.clear(),this._pendingGraphics.forEach((function(t){e._view.graphics.removeMany(t)})),this._pendingGraphics.clear(),this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null))}},{key:"showDataExtent",value:function(e){if(this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null),!(0,m.Wi)(e)){var t=V.Z.fromExtent(e);this._dataExtentGraphic=new O.Z({geometry:t,symbol:this._dataExtentSymbol}),this._view.graphics.add(this._dataExtentGraphic)}}},{key:"_synchronizeMaps",value:function(e,t){var i=this,r=[];e.forEach((function(e,n){var a=i._tileFetcher.test.getFeatureTileById(n);a&&t.filter(a)||(i._view.graphics.removeMany(e),r.push(n))})),r.forEach((function(t){return e.delete(t)})),this._tileFetcher.test.forEachFeatureTile((function(r){if(t.filter(r)&&!e.has(r.id)){var n=(0,Z.Z)(r.descriptor.lij,3),a=n[0],s=n[1],u=n[2];i._tilingScheme.ensureMaxLod(a);var o=i._tilingScheme.getExtentGeometry(a,s,u),l=[new O.Z({geometry:o,symbol:t.symbols[a%t.symbols.length]}),new O.Z({geometry:o.center,symbol:new I.Z({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new M.Z({text:"".concat(a,"/").concat(s,"/").concat(u),halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];e.set(r.id,l),i._view.graphics.addMany(l)}}))}}]),e}(),L=i(94463),G=function(e){(0,o.Z)(i,e);var t=(0,l.Z)(i);function i(e){var r;return(0,s.Z)(this,i),(r=t.call(this,e)).type="feature-tile-3d",r._watchUpdatingTracking=new E.t,r.serviceDataExtent=null,r.serviceDataCount=H.NO_SERVICE_DATA_COUNT,r.vertexLimitExceeded=!1,r.displayFeatureLimit=null,r._suspended=!1,r._tileFetcher=null,r._handles=new y.Z,r._fetchDataInfoPromise=null,r._fetchDataInfoAbortController=null,r._lifeCycleAbortController=new AbortController,r}return(0,u.Z)(i,[{key:"extent",set:function(e){if(!(0,m.pC)(e)||e.spatialReference.equals(this.layerView.view.spatialReference)){var t=this._get("extent");if(t!==e&&!((0,m.pC)(t)&&e&&t.equals(e))){var i=(0,m.pC)(e)?e.clone():null;this._set("extent",i)}}else v.Z.getLogger(this.declaredClass).error("#extent=","extent needs to be in the same spatial reference as the view")}},{key:"updating",get:function(){return!!((0,m.pC)(this._tileFetcher)&&this._tileFetcher.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this._watchUpdatingTracking&&this._watchUpdatingTracking.updating)}},{key:"updatingTotal",get:function(){return this.updating&&(0,m.pC)(this._tileFetcher)?this._tileFetcher.updatingTotal:0}},{key:"updatingRemaining",get:function(){return this.updating&&(0,m.pC)(this._tileFetcher)?this._tileFetcher.updatingRemaining:0}},{key:"expectedFeatureDiff",get:function(){return this.updating&&(0,m.pC)(this._tileFetcher)?this._tileFetcher.expectedFeatureDiff:0}},{key:"memoryForUnusedFeatures",get:function(){return(0,m.pC)(this._tileFetcher)?this._tileFetcher.memoryForUnusedFeatures:0}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!(!(0,m.pC)(this._tileFetcher)||!this._tileFetcher.maximumNumberOfFeaturesExceeded)}},{key:"maximumNumberOfFeatures",get:function(){return(0,m.pC)(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0},set:function(e){e!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",e)}},{key:"hasMaximumNumberOfFeaturesOverride",get:function(){return this._isOverridden("maximumNumberOfFeatures")}},{key:"mode",get:function(){var e,t,i=this.layerView.layer;if("feature"===i.type&&(0,m.pC)(i.infoFor3D))return"snapshot";if(!1===(null===(e=this.layerView.view.qualitySettings)||void 0===e||null===(t=e.graphics3D)||void 0===t?void 0:t.snapshotAvailable)||this.serviceDataCount===H.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";var r=this.layerView.view,n=r&&r.featureTiles,a=n&&n.tilingScheme;if(i&&i.minScale&&this.serviceDataExtent&&a){var s=this._approximateExtentSizeAtScale(i.minScale,a);if((this.serviceDataExtent.width/s+this.serviceDataExtent.height/s)/2>H.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}},{key:"maxTotalSnapshotVertices",get:function(){var e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&(0,m.pC)(this._tileFetcher)&&this._tileFetcher.totalVertices||0;return Math.max(e,t)}},{key:"_approximateExtentSizeAtScale",value:function(e,t){var i=this.layerView.view,r=Math.ceil((i.width/t.pixelSize+i.height/t.pixelSize)/2),n=t.levels[0];return r*((n.tileSize[0]/(n.scale/e)+n.tileSize[1]/(n.scale/e))/2)}},{key:"tileDescriptors",get:function(){return"snapshot"===this.mode?new p.Z([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new p.Z}},{key:"test",get:function(){return{fetchDataInfoPromise:this._fetchDataInfoPromise,tileFetcher:this._tileFetcher}}},{key:"initialize",value:function(){var e=this;this._watchUpdatingTracking.add((function(){return e.vertexLimitInfo}),(function(){return e._watchUpdatingTracking.addPromise(e._updateVertexLimitExceeded(null,e._lifeCycleAbortController.signal))})),this._watchUpdatingTracking.add((function(){return e.mode}),(function(){return e._modeChanged()}),F.nn),this.addResolvingPromise(Promise.resolve().then((function(){return e._verifyCapabilities()})).then((function(){return e._watchUpdatingTracking.addPromise(e._fetchServiceDataInfo())})).then((function(){return e._initializeTileFetcher()})))}},{key:"_verifyCapabilities",value:function(){var e,t=this.layerView.layer;if("ogc-feature"!==t.type&&(null===(e=(0,T.S1)(t))||void 0===e||!e.operations.supportsQuery))throw new f.Z("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:t})}},{key:"destroy",value:function(){this._cancelFetchServiceDataInfo(),this._tileFetcher=(0,m.SC)(this._tileFetcher),this._handles=(0,m.SC)(this._handles),this._tilesHandle=(0,m.hw)(this._tilesHandle),this._lifeCycleAbortController=(0,m.IM)(this._lifeCycleAbortController),this._watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}},{key:"suspend",value:function(){this._suspended||(this._suspended=!0,(0,m.pC)(this._tileFetcher)&&this._tileFetcher.suspend())}},{key:"resume",value:function(){this._suspended&&(this._suspended=!1,(0,m.pC)(this._tileFetcher)&&this._tileFetcher.resume())}},{key:"restart",value:function(){var e=this,t=function(){(0,m.pC)(e._tileFetcher)&&e._tileFetcher.restart()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(t,t))}},{key:"refetch",value:function(){var e=this,t=function(){(0,m.pC)(e._tileFetcher)&&e._tileFetcher.refetch()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(t,t))}},{key:"_initializeTileFetcher",value:function(){var e=this,t=this.layerView.view;if(t){var i=(0,F.N1)((function(){var e;return null===(e=t.featureTiles)||void 0===e?void 0:e.tilingScheme}),this._lifeCycleAbortController.signal);this._watchUpdatingTracking.addPromise(i),i.then((function(){var i=e.layerView,r=e.tileDescriptors,n=i.layer,a=new S.j({context:e.context,filterExtent:e.extent,tileDescriptors:r,features:e.graphics});e._tileFetcher=a,e._suspended?e._tileFetcher.suspend():e._tileFetcher.resume();var s=e.layerView.view.resourceController;s&&e._handles.add((0,F.YP)((function(){return s.memoryController.memoryFactor}),(function(e){return a.memoryFactor=e}),F.tX));var u="polygon"===e.context.geometryType?"polygonLodFactor":"polyline"===e.context.geometryType?"polylineLodFactor":null;u&&e._handles.add((0,F.YP)((function(){var t,i,r;return null===(t=e.layerView.view)||void 0===t||null===(i=t.qualitySettings)||void 0===i||null===(r=i.graphics3D)||void 0===r?void 0:r[u]}),(function(e){return a.lodFactor=e||1}),F.nn));"ogc-feature"!==n.type&&e._watchUpdatingTracking.add((function(){return n.createQueryVersion}),(function(){return e._dataFilterChanged()})),e._watchUpdatingTracking.add((function(){return i.availableFields}),(function(t,i){return e._availableFieldsChanged(i,t)})),e._watchUpdatingTracking.add((function(){return i.requiredFields}),(function(t,i){return e._requiredFieldsChanged(i,t)})),e._handles.add([n.on("apply-edits",(function(t){return e._applyEdits(t)})),(0,F.YP)((function(){return e.extent}),(function(e){return a.filterExtent=e}),F.Z_),(0,F.YP)((function(){return e.tileDescriptors}),(function(e){return a.tileDescriptors=e}),F.Z_),(0,F.YP)((function(){return e.maximumNumberOfFeatures}),(function(t){a.maximumNumberOfFeatures=t,a.useTileCount=e.serviceDataCount>t}),F.tX),(0,F.YP)((function(){return e.serviceDataCount}),(function(t){return a.useTileCount=t>e.maximumNumberOfFeatures}),F.tX),(0,F.YP)((function(){return L.Z.FEATURE_TILE_FETCH_SHOW_TILES}),(function(i){i&&a&&!a.debugger?(a.debugger=new U(a,t.featureTiles.tilingScheme.toTileInfo(),t),a.debugger.update()):!i&&e._tileFetcher&&a.debugger&&(a.debugger.destroy(),a.debugger=null)}),F.tX)]),e._supportsExceedsLimitQuery||e._watchUpdatingTracking.add((function(){return e.maxTotalSnapshotVertices}),(function(){return e._watchUpdatingTracking.addPromise(e._updateVertexLimitExceeded(null,e._lifeCycleAbortController.signal))}))})).catch((function(){}))}}},{key:"_modeChanged",value:function(){switch(this.mode){case"tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.featureTiles.addClient());break;default:v.Z.getLogger(this.declaredClass).warn("Unhandled feature layer mode "+this.mode);case"snapshot":(0,m.pC)(this._tilesHandle)&&(this._tilesHandle.remove(),this._tilesHandle=null)}}},{key:"_dataFilterChanged",value:function(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}},{key:"_applyEdits",value:function(e){var t=this;(0,m.Wi)(this._tileFetcher)||this._tileFetcher.applyEdits(e).then((function(e){if(e){if(!t._lifeCycleAbortController)throw(0,b.zE)();(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&t._watchUpdatingTracking.addPromise(t._updateServiceDataExtent(t._lifeCycleAbortController.signal))}})).catch((function(e){if(!(0,b.D_)(e))throw e}))}},{key:"_availableFieldsChanged",value:function(e,t){(0,m.pC)(this._tileFetcher)&&Q(this._tileFetcher.availableFields,t)&&this.refetch()}},{key:"_requiredFieldsChanged",value:function(e,t){(0,m.pC)(this._tileFetcher)&&Q(this._tileFetcher.availableFields,t)&&this.restart()}},{key:"_createVertexLimitExceededQuery",value:function(e){var t,i=this.layerView.layer,r=i.createQuery();return r.outStatistics=[new R.Z({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],null!==(t=i.capabilities)&&void 0!==t&&t.query.supportsCacheHint&&(r.cacheHint=!0),r}},{key:"_createDataInfoQuery",value:function(){var e,t=this.layerView.layer,i=t.createQuery();return i.outSpatialReference=this.layerView.view.spatialReference,null!==(e=t.capabilities)&&void 0!==e&&e.query.supportsCacheHint&&(i.cacheHint=!0),i}},{key:"_fullExtentIsAccurate",value:function(){var e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":case"oriented-imagery":return(0,k.M8)(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}},{key:"_updateServiceDataExtent",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._tryUpdateServiceDataExtent(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),(0,b.D_)(e.t0)||this._set("serviceDataExtent",(0,_.d9)(this.layerView.fullExtentInLocalViewSpatialReference));case 8:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_tryUpdateServiceDataExtent",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var i,r,a,s,u,o,l,c,h,d,p,f,y;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this.layerView,s=a.layer,u=null!==(i=null===(r=s.capabilities)||void 0===r?void 0:r.query.supportsExtent)&&void 0!==i&&i,o=(0,_.d9)(a.fullExtentInLocalViewSpatialReference),l=s.fullExtent,c=this._fullExtentIsAccurate(),h=this.serviceDataCount,!(u&&h<=H.MAX_FEATURE_COUNT_FOR_EXTENT)||o&&c||!("queryExtent"in s)){e.next=9;break}return d=this._createDataInfoQuery(),e.next=5,s.queryExtent(d,{timeout:H.QUERY_EXTENT_TIMEOUT,signal:t});case 5:p=e.sent,this._set("serviceDataExtent",p.extent),e.next=22;break;case 9:if(!o){e.next=13;break}this._set("serviceDataExtent",o),e.next=22;break;case 13:if(!(0,m.pC)(l)){e.next=21;break}return f="portalItem"in s?s.portalItem:null,e.next=17,(0,w.projectGeometry)(l,a.view.spatialReference,f,t);case 17:y=e.sent,this._set("serviceDataExtent",y),e.next=22;break;case 21:this._set("serviceDataExtent",null);case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateServiceDataCount",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var i,r;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("queryFeatureCount"in(i=this.layerView.layer)){e.next=3;break}return e.abrupt("return",void this._set("serviceDataCount",H.NO_SERVICE_DATA_COUNT));case 3:return e.next=5,(0,d.q6)(i.queryFeatureCount(this._createDataInfoQuery(),{timeout:H.QUERY_STATISTICS_TIMEOUT,signal:t}));case 5:if(!0!==(r=e.sent).ok){e.next=10;break}this._set("serviceDataCount",r.value),e.next=13;break;case 10:if(!(0,b.D_)(r.error)){e.next=12;break}throw r.error;case 12:this._set("serviceDataCount",H.NO_SERVICE_DATA_COUNT);case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"vertexLimitInfo",get:function(){if((0,m.Wi)(this.displayFeatureLimit)||(0,m.Wi)(this.displayFeatureLimit.averageSymbolComplexity))return null;var e=this.displayFeatureLimit,t=e.averageSymbolComplexity,i=e.maximumTotalNumberOfPrimitives,r=t.primitivesPerCoordinate,n=t.primitivesPerFeature,a=this._get("vertexLimitInfo");return(0,m.Wi)(a)||a.maximumTotalNumberOfPrimitives!==i||a.primitivesPerCoordinate!==r||a.primitivesPerFeature!==n?{primitivesPerCoordinate:r,primitivesPerFeature:n,maximumTotalNumberOfPrimitives:i}:a}},{key:"_supportsExceedsLimitQuery",get:function(){var e=this.layerView.layer;return null!=e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}},{key:"_minimumNumberOfVerticesForGeometry",get:function(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}},{key:"_updateVertexLimitExceeded",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i){var r,a,s,u,o,l,c,h,p,f,y;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.vertexLimitInfo,!(0,m.Wi)(r)){e.next=3;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 3:if(a=r.primitivesPerFeature<=0,s=this._minimumNumberOfVerticesForGeometry>1,a||s){e.next=6;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 6:if(u=r.primitivesPerFeature,o=r.primitivesPerCoordinate,l=r.maximumTotalNumberOfPrimitives,e.t0=0!==u&&(0,m.pC)(t),!e.t0){e.next=11;break}return e.next=11,t;case 11:if(h=this.serviceDataCount,p=h!==H.NO_SERVICE_DATA_COUNT,c=p?Math.ceil((l-h*u)/(o||1)):Math.ceil(l/(o||1)),s&&(c=Math.min(c,z)),!(p&&this._minimumNumberOfVerticesForGeometry*h>c)){e.next=14;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!0));case 14:if(this._supportsExceedsLimitQuery){e.next=16;break}return e.abrupt("return",void this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>c));case 16:return e.next=18,(0,d.q6)(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(c),{timeout:H.QUERY_STATISTICS_TIMEOUT,signal:i}));case 18:if(!1!==(f=e.sent).ok){e.next=23;break}if(!(0,b.D_)(f.error)){e.next=22;break}throw f.error;case 22:return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 23:(y=f.value.features[0])&&y.attributes?this._set("vertexLimitExceeded",!!y.attributes.exceedslimit):this._set("vertexLimitExceeded",!1);case 25:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_fetchServiceDataInfo",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(){var t,i,r,a,s,u=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._cancelFetchServiceDataInfo(),t=new AbortController,i=t.signal,r=this._updateServiceDataCount(i),a=(0,b.as)([r,this._updateVertexLimitExceeded(r,i)]),s=a.then((function(){return u._updateServiceDataExtent(i)})).catch((function(e){(0,b.D_)(e)||v.Z.getLogger(u.declaredClass).error("#fetchServiceDataInfo()",e)})).then((function(){s===u._fetchDataInfoPromise&&(u._fetchDataInfoPromise=null,u._fetchDataInfoAbortController=null),t=null})),e.abrupt("return",(t&&(this._fetchDataInfoPromise=s),this._fetchDataInfoAbortController=t,a.then((function(){}),(function(){}))));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_cancelFetchServiceDataInfo",value:function(){var e=this._fetchDataInfoAbortController;e&&(this._fetchDataInfoAbortController=null,this._fetchDataInfoPromise=null,e.abort())}},{key:"debug",get:function(){return{storedFeatures:(0,m.pC)(this._tileFetcher)?this._tileFetcher.storedFeatures:0,totalFeatures:(0,m.pC)(this._tileFetcher)?this._tileFetcher.totalFeatures:0,totalVertices:(0,m.pC)(this._tileFetcher)?this._tileFetcher.totalVertices:0,missingTiles:(0,m.pC)(this._tileFetcher)?this._tileFetcher.missingTiles:0}}}]),i}((0,g.v)(h.Z));(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"type",void 0),(0,c._)([(0,C.Cb)({constructOnly:!0})],G.prototype,"graphics",void 0),(0,c._)([(0,C.Cb)({constructOnly:!0})],G.prototype,"layerView",void 0),(0,c._)([(0,C.Cb)({constructOnly:!0})],G.prototype,"context",void 0),(0,c._)([(0,C.Cb)()],G.prototype,"extent",null),(0,c._)([(0,C.Cb)()],G.prototype,"updating",null),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"_watchUpdatingTracking",void 0),(0,c._)([(0,C.Cb)()],G.prototype,"updatingTotal",null),(0,c._)([(0,C.Cb)()],G.prototype,"updatingRemaining",null),(0,c._)([(0,C.Cb)()],G.prototype,"expectedFeatureDiff",null),(0,c._)([(0,C.Cb)()],G.prototype,"memoryForUnusedFeatures",null),(0,c._)([(0,C.Cb)()],G.prototype,"maximumNumberOfFeaturesExceeded",null),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"serviceDataExtent",void 0),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"serviceDataCount",void 0),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"vertexLimitExceeded",void 0),(0,c._)([(0,C.Cb)()],G.prototype,"displayFeatureLimit",void 0),(0,c._)([(0,C.Cb)({type:Number})],G.prototype,"maximumNumberOfFeatures",null),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"mode",null),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"maxTotalSnapshotVertices",null),(0,c._)([(0,C.Cb)({readOnly:!0,dependsOn:["mode"]})],G.prototype,"tileDescriptors",null),(0,c._)([(0,C.Cb)()],G.prototype,"_tileFetcher",void 0),(0,c._)([(0,C.Cb)()],G.prototype,"_fetchDataInfoPromise",void 0),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"vertexLimitInfo",null),G=(0,c._)([(0,x.j)("esri.layers.graphics.controllers.FeatureTileController3D")],G);var H,q,z=5e6;function Q(e,t){if(!t)return!1;var i,n=(0,r.Z)(t);try{for(n.s();!(i=n.n()).done;){var a=i.value;if(!e.has(a))return!0}}catch(s){n.e(s)}finally{n.f()}return!1}(q=H||(H={})).NO_SERVICE_DATA_COUNT=1/0,q.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,q.reset=function(){q.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,q.QUERY_STATISTICS_TIMEOUT=12e3,q.QUERY_EXTENT_TIMEOUT=1e4},H.reset()},43682:function(e,t,i){i.d(t,{R:function(){return Be}});var r=i(1413),n=i(74165),a=i(15861),s=i(15671),u=i(43144),o=i(11752),l=i(61120),c=i(60136),h=i(29388),d=i(27366),p=i(10064),f=i(92026),y=i(94172),_=i(49861),v=(i(25243),i(63780),i(69912)),m=i(37818),g=i(5845),b=i(86638),F=i(74579),C=i(60487),x=i(53586),E=i(82607),k=i(77098),T=i(37762),w=i(59896),R=i(41691),S=i(42537),Z=i(32718),O=i(17842),V=i(11186),D=i(71353),I=i(79803),P=i(82582),M=i(65618),A=i(83406),N=i(3182),U=i(80457),L=i(68928),G=i(80031),H=i(27811),q=i(26279),z=i(26511),Q=i(19384),j=i(91526),W=i(79100),B=i(50951),Y=i(20684),X=i(81341),J=i(98634),K=i(82144),$=i(31132),ee=i(33559),te=i(7566),ie=i(78041),re=i(27627),ne=i(8883),ae=i(23819),se=i(8548),ue=i(36207),oe=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(){var e;return(0,s.Z)(this,i),(e=t.apply(this,arguments)).colorRamp=null,e.densityMap=null,e.searchRadius=1,e.fieldTotal=0,e.minDensity=0,e.maxDensity=100,e}return(0,u.Z)(i)}(J.K),le=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(e,r){var n;return(0,s.Z)(this,i),n=t.call(this,e,r,(function(){return n.destroy()}))}return(0,u.Z)(i,[{key:"initializeProgram",value:function(e){return new re.$(e.rctx,i.shader.get().build(this.configuration),te.i)}},{key:"initializePipeline",value:function(){return(0,ue.sm)({blending:ie.wu,colorWrite:ue.BK,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return se.MX.TRIANGLE_STRIP}}]),i}($.A);le.shader=new K.J(ae.H,(function(){return i.e(8259).then(i.bind(i,28259))}));var ce=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(){var e;return(0,s.Z)(this,i),(e=t.apply(this,arguments)).usesHalfFloat=!1,e}return(0,u.Z)(i)}(ne.W);(0,d._)([(0,ee.o)()],ce.prototype,"usesHalfFloat",void 0);var he=i(53634),de=i(371),pe=i(3384),fe=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(e){var r;return(0,s.Z)(this,i),(r=t.call(this,e)).pixelRatio=1,r._colorRampData=new Uint8ClampedArray(4),r.type="draped-heatmap",r._heatmapParameters=new oe,r}return(0,u.Z)(i,[{key:"initialize",value:function(){var e=this,t={colorTarget:se.Lm.TEXTURE,depthStencilTarget:se.OU.NONE,width:0,height:0},i={target:se.No.TEXTURE_2D,pixelFormat:this.pixelFormat,internalFormat:this.internalFormat,dataType:this.dataType,samplingMode:this.samplingMode,wrapMode:se.e8.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new he.X(this.rctx,t,i),this._quad=(0,Y.ow)(this.rctx);var r=this._colorRampData,n={target:se.No.TEXTURE_2D,pixelFormat:se.VI.RGBA,dataType:se.Br.UNSIGNED_BYTE,samplingMode:se.cw.LINEAR,wrapMode:se.e8.CLAMP_TO_EDGE,width:r.length/4,height:1};this._colorRamp=new de.x(this.rctx,n,r);var a=new ce;a.usesHalfFloat=this.dataType!==se.Br.FLOAT,this._technique=new le({rctx:this.rctx,viewingMode:B.JY.Local},a),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles((0,y.YP)((function(){return[e.colorRampData,e.minDensity,e.maxDensity,e.fieldTotal,e.pixelRatio,e.searchRadius]}),(function(){return e.rendererContext.notifyContentChanged()})))}},{key:"destroy",value:function(){this._technique=(0,f.RY)(this._technique),this._densityMap=(0,f.M2)(this._densityMap),this._quad=(0,f.M2)(this._quad),this._colorRamp=(0,f.M2)(this._colorRamp)}},{key:"searchRadius",get:function(){return this._heatmapParameters.searchRadius},set:function(e){e!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=e,this.notifyChange("searchRadius"))}},{key:"minDensity",get:function(){return this._heatmapParameters.minDensity},set:function(e){e!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=e,this.notifyChange("minDensity"))}},{key:"maxDensity",get:function(){return this._heatmapParameters.maxDensity},set:function(e){e!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=e,this.notifyChange("maxDensity"))}},{key:"fieldTotal",get:function(){return this._heatmapParameters.fieldTotal},set:function(e){this._heatmapParameters.fieldTotal=e,this.notifyChange("fieldTotal")}},{key:"colorRampData",get:function(){return this._colorRampData},set:function(e){var t=this._heatmapParameters.colorRamp;if((0,f.pC)(t)&&e!==this._colorRampData){var i=t.descriptor.width,r=e.length/4;r!==i&&t.resize(r,1),t.setData(e)}this._colorRampData=e}},{key:"_colorRamp",get:function(){return this._heatmapParameters.colorRamp},set:function(e){this._heatmapParameters.colorRamp=e}},{key:"hasHighlights",get:function(){return!1}},{key:"hasWater",get:function(){return!1}},{key:"rendersOccluded",get:function(){return!1}},{key:"render",value:function(e){var t=this._sortedMaterialRenderers;if(!(t.length<1)){var i=this.rctx.getBoundFramebufferObject(),r=this.rctx.getViewport(),n=e.bindParameters,a=this.pixelRatio,s=Math.ceil(r.width*a),u=Math.ceil(r.height*a);this._densityMap.resize(s,u),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,s,u),this.rctx.clear(se.lk.COLOR_BUFFER_BIT);var o=!1;t.forAll((function(t){t.material.shouldRender(e)&&(o=t.render(e.output,n)||o)})),this.rctx.bindFramebuffer(i),this.rctx.setViewport(r.x,r.y,r.width,r.height),o&&(this.rctx.bindVAO(this._quad),this.rctx.bindTechnique(this._technique,this._heatmapParameters,e.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,(0,pe._V)(this._quad,"geometry")))}}}]),i}(X.S);(0,d._)([(0,_.Cb)()],fe.prototype,"searchRadius",null),(0,d._)([(0,_.Cb)()],fe.prototype,"minDensity",null),(0,d._)([(0,_.Cb)()],fe.prototype,"maxDensity",null),(0,d._)([(0,_.Cb)()],fe.prototype,"fieldTotal",null),(0,d._)([(0,_.Cb)()],fe.prototype,"pixelRatio",void 0),(0,d._)([(0,_.Cb)()],fe.prototype,"colorRampData",null),(0,d._)([(0,_.Cb)({constructOnly:!0})],fe.prototype,"dataType",void 0),(0,d._)([(0,_.Cb)({constructOnly:!0})],fe.prototype,"samplingMode",void 0),(0,d._)([(0,_.Cb)({constructOnly:!0})],fe.prototype,"pixelFormat",void 0),(0,d._)([(0,_.Cb)({constructOnly:!0})],fe.prototype,"internalFormat",void 0),(0,d._)([(0,_.Cb)()],fe.prototype,"_colorRampData",void 0),fe=(0,d._)([(0,v.j)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],fe);var ye=i(40779),_e=i(78289),ve=i(39077),me=i(78485),ge=i(4760),be=i(88396),Fe=i(6394),Ce=i(55158),xe=i(37081),Ee=i(23620),ke=i(56529),Te=i(93822),we=i(33236),Re=i(65322),Se=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(){var e;return(0,s.Z)(this,i),(e=t.apply(this,arguments)).searchRadius=128,e.resolutionForScale=0,e}return(0,u.Z)(i)}(ke.Mt),Ze=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(){return(0,s.Z)(this,i),t.apply(this,arguments)}return(0,u.Z)(i,[{key:"initializeProgram",value:function(e){return new re.$(e.rctx,i.shader.get().build(this.configuration),te.i)}},{key:"initializePipeline",value:function(){return(0,ue.sm)({blending:(0,ue.if)(se.zi.ONE,se.zi.ONE,se.db.ADD),colorWrite:ue.BK,depthTest:null,depthWrite:null})}},{key:"destroy",value:function(){(0,o.Z)((0,l.Z)(i.prototype),"destroy",this).call(this)}}]),i}($.A);Ze.shader=new K.J(Re.H,(function(){return i.e(7682).then(i.bind(i,7682))}));var Oe=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(){var e;return(0,s.Z)(this,i),(e=t.apply(this,arguments)).isAttributeDriven=!1,e.usesHalfFloat=!1,e}return(0,u.Z)(i)}(ne.W);(0,d._)([(0,ee.o)()],Oe.prototype,"isAttributeDriven",void 0),(0,d._)([(0,ee.o)()],Oe.prototype,"usesHalfFloat",void 0);var Ve=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(){var e;return(0,s.Z)(this,i),(e=t.apply(this,arguments)).isAttributeDriven=!1,e.usesHalfFloats=!1,e}return(0,u.Z)(i)}(Se),De=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(e){var r;return(0,s.Z)(this,i),(r=t.call(this,e,new Ve))._configuration=new Oe,r}return(0,u.Z)(i,[{key:"requiresSlot",value:function(e,t){return e===Te.r.DRAPED_MATERIAL&&t===xe.H.Color}},{key:"getConfiguration",value:function(){return this._configuration.isAttributeDriven=this.parameters.isAttributeDriven,this._configuration.usesHalfFloat=this.parameters.usesHalfFloats,this._configuration}},{key:"createGLMaterial",value:function(e){return new Ie(e)}},{key:"intersect",value:function(){}},{key:"intersectDraped",value:function(e,t,i,r,n,a){for(var s=e.vertexAttributes.get(ge.T.POSITION),u=this.parameters.searchRadius,o=e.screenToWorldRatio,l=u*o+2*o,c=l*l,h=s.data.length/s.size,d=0;d<h;d++){var p=d*s.size,f=(0,be.s)(Ue,s.data[p],s.data[p+1]);(0,be.k)(f,r)<c&&n(a.dist,a.normal,-1,!1)}}},{key:"createBufferWriter",value:function(){return new Pe(this.parameters.isAttributeDriven?Ae:Me)}}]),i}(ke.F5),Ie=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(){return(0,s.Z)(this,i),t.apply(this,arguments)}return(0,u.Z)(i,[{key:"beginSlot",value:function(e){return this.ensureTechnique(Ze,e)}}]),i}(Ee.Z),Pe=function(){function e(t){(0,s.Z)(this,e),this.vertexBufferLayout=t}return(0,u.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices.get(ge.T.POSITION).length*Ne}},{key:"write",value:function(e,t,i,r,n){(0,we.ho)(i.indices.get(ge.T.POSITION),i.vertexAttributes.get(ge.T.POSITION).data,e,r.position,n,Ne);for(var a=i.indices.get(ge.T.POSITION).length,s=r.uv0,u=n,o=0;o<a;++o)s.setValues(u++,-1,-1),s.setValues(u++,1,-1),s.setValues(u++,1,1),s.setValues(u++,1,1),s.setValues(u++,-1,1),s.setValues(u++,-1,-1);var l=ge.T.FEATUREATTRIBUTE in r?r.featureAttribute:null;l&&(0,we.XW)(i.indices.get(ge.T.FEATUREATTRIBUTE),i.vertexAttributes.get(ge.T.FEATUREATTRIBUTE).data,l,n,Ne)}}]),e}(),Me=(0,Ce.U$)().vec3f(ge.T.POSITION).vec2f(ge.T.UV0),Ae=Me.clone().f32(ge.T.FEATUREATTRIBUTE),Ne=6,Ue=(0,Fe.a)(),Le=i(69787),Ge=i(34552),He="esri.views.3d.layers.support.HeatmapFeatureProcessor",qe=Z.Z.getLogger(He),ze=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(e){var r;return(0,s.Z)(this,i),(r=t.call(this,e)).type="heatmap",r.preferredUpdatePolicy=me.j.ASYNC,r.dataExtent=null,r.drapeSourceType=q.Lw.Features,r._renderGeometries=new Map,r._fieldTotal=0,r._drapeSourceRenderer=null,r._dataType=se.Br.HALF_FLOAT,r._pixelFormat=se.VI.RGBA,r.initializePromise=Promise.resolve(),r}return(0,u.Z)(i,[{key:"initialize",value:function(){var e=this;this._featureStore=new L.Z({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});var t=(0,Ge.v)(this._renderView.renderingContext,qe),i=t.dataType,n=t.samplingMode,a=t.pixelFormat,s=t.internalFormat;this._dataType=i,this._pixelFormat=a;var u=i!==se.Br.FLOAT;this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,fe,(0,r.Z)((0,r.Z)({},this._rendererParameters),{},{dataType:i,samplingMode:n,pixelFormat:a,internalFormat:s})),this._material=new De({usesHalfFloats:u}),this._materialWithField=new De({usesHalfFloats:u,isAttributeDriven:!0}),this._filterVisibility=new z.n({context:{layerView:this.owner,featureStore:this.featureStore,getFeatureCount:function(){return e._loadedPointGraphics.length},setAllFeaturesVisibility:function(t){return e._setAllFeaturesVisibility(t)},clearFeaturesVisibility:function(){return e._setAllFeaturesVisibility(!0)},updateFeatureVisibilities:function(t){return e._updateFeatureVisibilities(t)}}}),this.updatingHandles.addOnCollectionChange((function(){return e._loadedPointGraphics}),(function(t){return e._onLoadedFeaturesChange(t)}),y.nn),this.updatingHandles.addWhen((function(){return e._materialParameters}),(function(t){return e._forEachMaterial((function(e){return e.setParameters(t)}))}),y.nn),this.updatingHandles.add((function(){return e._rendererParameters}),(function(t){return e._drapeSourceRenderer.set(t)})),this.updatingHandles.add((function(){return e._heatmapRendererField}),(function(){e._recreate()}),y.Z_),this.updatingHandles.add((function(){return{fieldName:e._heatmapRendererFieldName,numeric:e._heatmapRendererFieldIsNumeric}}),(function(t){var i=t.fieldName,r=t.numeric;if((0,f.pC)(i)&&r){var n=0;e._featureStore.forEach((function(e){var t;return n+=null!==(t=e.attributes[i])&&void 0!==t?t:0})),e._fieldTotal=n}else e._fieldTotal=e._featureStore.numFeatures}),y.nn),this.handles.add([(0,y.YP)((function(){return{fieldName:e._heatmapRendererFieldName,field:e._heatmapRendererField}}),(function(t){var i,r=t.fieldName,n=t.field;r&&!n&&qe.warn("Heatmap renderer field '".concat(r,"' for layer '").concat(null!==(i=e.layer.title)&&void 0!==i?i:e.layer.id,"' not found"))})),(0,y.YP)((function(){return{field:e._heatmapRendererField,numeric:e._heatmapRendererFieldIsNumeric}}),(function(t){var i,r=t.field,n=t.numeric;(0,f.pC)(r)&&!n&&qe.warn("Heatmap renderer field '".concat(r.name,"' for layer '").concat(null!==(i=e.layer.title)&&void 0!==i?i:e.layer.id,"' does not contain numeric values and cannot be used to drive the heatmap density"))})),(0,S.kB)((function(){return e.view.basemapTerrain.overlayManager.unregisterDrapeSource(e)}))])}},{key:"destroy",value:function(){this._renderGeometries.clear(),this._material=(0,f.M2)(this._material),this._materialWithField=(0,f.M2)(this._materialWithField),this._featureStore.clear(),this._featureStore=null}},{key:"layer",get:function(){return this.owner.layer}},{key:"featureStore",get:function(){return this._featureStore}},{key:"updating",get:function(){return this.updatingHandles.updating||this.filterVisibility.updating}},{key:"updatingRemaining",get:function(){return 0}},{key:"suspendInfo",get:function(){return{}}},{key:"legendEnabled",get:function(){return!0}},{key:"filterVisibility",get:function(){return this._filterVisibility}},{key:"displayFeatureLimit",get:function(){var e,t,i,r,n,a,s,u=null!==(e=null===(t=this.owner)||void 0===t||null===(i=t.view)||void 0===i||null===(r=i.resourceController)||void 0===r||null===(n=r.memoryController)||void 0===n?void 0:n.memoryFactor)&&void 0!==e?e:1,o=null===(a=this.owner)||void 0===a||null===(s=a.view)||void 0===s?void 0:s.qualitySettings,l=o?Math.ceil(o.heatmap.maxTotalNumberOfFeatures*u):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:l,maximumTotalNumberOfPrimitives:2*l,maximumNumberOfFeatures:l}}},{key:"hasZ",get:function(){return"hasZ"in this.layer&&this.layer.hasZ}},{key:"hasM",get:function(){return"hasM"in this.layer&&this.layer.hasM}},{key:"view",get:function(){return this.owner.view}},{key:"fullOpacity",get:function(){return this.owner.fullOpacity}},{key:"updatePolicy",get:function(){return this.owner.updatePolicy}},{key:"scaleVisibilitySuspended",get:function(){if(!this._isScaleRangeActive)return!1;var e=this.layer.effectiveScaleRange,t=e.minScale,i=e.maxScale,r=this.view.scale;return!(0,Le.rs)(r,null!==t&&void 0!==t?t:0,null!==i&&void 0!==i?i:0)}},{key:"usedMemory",get:function(){var e,t,i,r,n=this.usedMemoryPerFeature*this._featureStore.numFeatures,a=this._pixelFormat===se.VI.RED?1:4,s=this._dataType===se.Br.FLOAT?4:2,u=null!==(e=Math.ceil((null!==(t=null===(i=this._overlayRenderer)||void 0===i||null===(r=i.overlays[0])||void 0===r?void 0:r.resolution)&&void 0!==t?t:0)*this._densityMapPixelRatio))&&void 0!==e?e:0;return u*u*a*s+n}},{key:"usedMemoryPerFeature",get:function(){var e=this._loadedPointGraphics.find((function(){return!0}));if((0,f.Wi)(e))return 0;var t=(0,w.f2)(e),i=(0,w.G3)();return 6*(0,w.do)([0,0,0],i)+6*(0,w.do)([0,0],i)+(this._heatmapRendererFieldIsNumeric?6*i:0)+t}},{key:"loadedFeatures",get:function(){return this._featureStore.numFeatures}},{key:"unprocessedMemoryEstimate",get:function(){return 0}},{key:"performanceInfo",get:function(){return{core:{visible:this._visibleFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}},{key:"renderer",get:function(){return this._heatmapRenderer}},{key:"_overlayRenderer",get:function(){return this.view.basemapTerrain.overlayManager.renderer}},{key:"_overlaySpatialReference",get:function(){return(0,f.Wg)(this._overlayRenderer.spatialReference)}},{key:"_rendererParameters",get:function(){return(0,r.Z)((0,r.Z)((0,r.Z)((0,r.Z)({},this._radiusParameter),this._densityParameters),this._colorRampParameter),this._pixelRatioParameter)}},{key:"_materialParameters",get:function(){return(0,r.Z)((0,r.Z)({},this._radiusParameter),this._resolutionForScaleParameter)}},{key:"_densityParameters",get:function(){var e=this._heatmapRenderer;return(0,f.Wi)(e)?null:{minDensity:e.minDensity,maxDensity:e.maxDensity,fieldTotal:this._fieldTotal}}},{key:"_radiusParameter",get:function(){var e=this;return(0,f.yw)(this._heatmapRenderer,(function(t){var i=t.radius;return{searchRadius:(0,O.F2)(e._clampSearchRadius(i))}}))}},{key:"_resolutionForScaleParameter",get:function(){var e=this;return(0,f.yw)(this._heatmapRenderer,(function(t){var i=t.referenceScale;return{resolutionForScale:0===i?0:(0,P.dp)(i,e.view.spatialReference)}}))}},{key:"_colorRampParameter",get:function(){return(0,f.yw)(this._heatmapRenderer,(function(e){return{colorRampData:(0,H.uI)(e.colorStops)}}))}},{key:"_pixelRatioParameter",get:function(){return{pixelRatio:this._densityMapPixelRatio}}},{key:"_densityMapPixelRatio",get:function(){var e,t,i,r,n,a,s,u,o=null!==(e=null===(t=this.owner)||void 0===t||null===(i=t.view)||void 0===i||null===(r=i.resourceController)||void 0===r||null===(n=r.memoryController)||void 0===n?void 0:n.memoryFactor)&&void 0!==e?e:1;return(null!==(a=null===(s=this.owner)||void 0===s||null===(u=s.view)||void 0===u?void 0:u.qualitySettings.heatmap.pixelRatio)&&void 0!==a?a:1)*Math.sqrt(o)}},{key:"_renderView",get:function(){return this.view._stage.renderView}},{key:"_featuresArePoints",get:function(){return"point"===this.layer.geometryType}},{key:"_loadedPointGraphics",get:function(){return this.owner.loadedGraphics}},{key:"_heatmapRenderer",get:function(){var e=this.layer.renderer;return"heatmap"===(null===e||void 0===e?void 0:e.type)?e:null}},{key:"_heatmapRendererFieldName",get:function(){return(0,f.yw)(this._heatmapRenderer,(function(e){return e.field}))}},{key:"_heatmapRendererField",get:function(){var e=this;return(0,f.yw)(this._heatmapRendererFieldName,(function(t){return e.layer.fieldsIndex.get(t)}))}},{key:"_heatmapRendererFieldIsNumeric",get:function(){var e=this._heatmapRendererField;return!(0,f.Wi)(e)&&(0,G.H7)(e)}},{key:"_isScaleRangeActive",get:function(){var e=this.layer;if(!("effectiveScaleRange"in e))return!1;var t=e.effectiveScaleRange,i=t.minScale,r=t.maxScale;return(0,Le.Av)(i,r)}},{key:"_visibleFeatures",get:function(){var e=0;return this._renderGeometries.forEach((function(t){t.visible&&++e})),e}},{key:"whenGraphicBounds",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"computeAttachmentOrigin",value:function(){return null}},{key:"highlight",value:function(){return Qe}},{key:"maskOccludee",value:function(){return Qe}},{key:"setObjectIdVisibility",value:function(){}},{key:"refreshFilter",value:function(){this.filterVisibility.reapply()}},{key:"_onLoadedFeaturesChange",value:function(e){var t=this;if(this._featuresArePoints){var i=this.layer.objectIdField;this._featureStore.removeManyById(e.removed.map((function(e){return(0,M.MS)(e,i)}))),this._featureStore.addMany(e.added.map((function(e){var t=new N.u_((0,A.dd)(new U.Z,e.geometry),e.attributes,(0,f.yw)(e.centroid,(function(e){return(0,A.dd)(new U.Z,e)})),(0,M.MS)(e,i));return t.displayId=e.uid,t})));var r=e.added,n=e.removed;this._fieldTotal+=this._computeFieldTotalChange(r,n);var a=(0,f.e8)(n,(function(e){var i=e.uid,r=t._renderGeometries.get(i);return t._renderGeometries.delete(i),r})),s=r.map((function(e){var i=t._pointGraphicToRenderGeometry(e);return t._renderGeometries.set(e.uid,i),i}));a.length>0&&this._drapeSourceRenderer.removeGeometries(a,_e.T.REMOVE),s.length>0&&this._drapeSourceRenderer.addGeometries(s,_e.T.ADD),(s.length>0||a.length>0)&&(this.filterVisibility.reapply(),this._renderView.requestRender())}}},{key:"_recreate",value:function(){if(this._loadedPointGraphics){var e=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:e,removed:e})}}},{key:"_pointGraphicToRenderGeometry",value:function(e){var t,i=this._heatmapRendererFieldName,r=(0,f.pC)(i)?this._materialWithField:this._material,n=(0,D.c)();(0,I.KC)(e.geometry,n,this._overlaySpatialReference),n[2]=Q.Rn;var a=[[ge.T.POSITION,new j.a(n,n.length)]],s=this._heatmapRendererFieldIsNumeric;(0,f.pC)(i)&&a.push([ge.T.FEATUREATTRIBUTE,new j.a([s&&null!==(t=e.attributes[i])&&void 0!==t?t:0],1)]);var u=new ve.z(new ye.Z(r,a,null,null,W.U.Point),{layerUid:this.layer.uid,graphicUid:e.uid});return(0,V.c)(u.boundingSphere,n),u.visible=this.filterVisibility.defaultVisibility,u}},{key:"_forEachMaterial",value:function(e){e(this._material),e(this._materialWithField)}},{key:"_computeFieldTotalChange",value:function(e,t){if((0,f.Wi)(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return e.length-t.length;var i=this._heatmapRendererFieldName,r=function(e,t){var r;return e+(null!==(r=t.attributes[i])&&void 0!==r?r:0)};return e.reduce(r,0)-t.reduce(r,0)}},{key:"_clampSearchRadius",value:function(e){return e>112&&qe.warnOnce("SceneView supports a maximum radius of ".concat(112," pt for HeatmapRenderer.")),Math.min(e,112)}},{key:"_updateFeatureVisibilities",value:function(e){var t=this,i=[];this._featureStore.forEach((function(r){var n=r.objectId,a=r.displayId,s=e(n),u=t._renderGeometries.get(a);u&&u.visible!==s&&(i.push(u),u.visible=s)})),this._drapeSourceRenderer.modifyGeometries(i,_e.$.VISIBILITY)}},{key:"_setAllFeaturesVisibility",value:function(e){var t,i=[],r=(0,T.Z)(this._renderGeometries.values());try{for(r.s();!(t=r.n()).done;){var n=t.value;n.visible!==e&&(i.push(n),n.visible=e)}}catch(a){r.e(a)}finally{r.f()}this._drapeSourceRenderer.modifyGeometries(i,_e.$.VISIBILITY)}},{key:"test",get:function(){return{visibleFeatureCount:this._visibleFeatures}}}]),i}(R.r);(0,d._)([(0,_.Cb)()],ze.prototype,"type",void 0),(0,d._)([(0,_.Cb)({constructOnly:!0})],ze.prototype,"owner",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"layer",null),(0,d._)([(0,_.Cb)()],ze.prototype,"featureStore",null),(0,d._)([(0,_.Cb)()],ze.prototype,"updating",null),(0,d._)([(0,_.Cb)()],ze.prototype,"updatingRemaining",null),(0,d._)([(0,_.Cb)()],ze.prototype,"suspendInfo",null),(0,d._)([(0,_.Cb)()],ze.prototype,"legendEnabled",null),(0,d._)([(0,_.Cb)()],ze.prototype,"filterVisibility",null),(0,d._)([(0,_.Cb)()],ze.prototype,"displayFeatureLimit",null),(0,d._)([(0,_.Cb)()],ze.prototype,"preferredUpdatePolicy",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"hasZ",null),(0,d._)([(0,_.Cb)()],ze.prototype,"hasM",null),(0,d._)([(0,_.Cb)()],ze.prototype,"dataExtent",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"view",null),(0,d._)([(0,_.Cb)()],ze.prototype,"fullOpacity",null),(0,d._)([(0,_.Cb)()],ze.prototype,"updatePolicy",null),(0,d._)([(0,_.Cb)()],ze.prototype,"drapeSourceType",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"scaleVisibilitySuspended",null),(0,d._)([(0,_.Cb)()],ze.prototype,"renderer",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_featureStore",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"_filterVisibility",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"_overlayRenderer",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_overlaySpatialReference",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_rendererParameters",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_materialParameters",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_densityParameters",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_radiusParameter",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_resolutionForScaleParameter",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_colorRampParameter",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_pixelRatioParameter",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_densityMapPixelRatio",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_renderGeometries",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"_material",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"_materialWithField",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"_renderView",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_featuresArePoints",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_loadedPointGraphics",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_heatmapRenderer",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_heatmapRendererFieldName",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_heatmapRendererField",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_heatmapRendererFieldIsNumeric",null),(0,d._)([(0,_.Cb)()],ze.prototype,"_fieldTotal",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"_drapeSourceRenderer",void 0),(0,d._)([(0,_.Cb)()],ze.prototype,"_isScaleRangeActive",null),ze=(0,d._)([(0,v.j)(He)],ze);var Qe=(0,S.kB)(),je=i(61712),We=i(93463),Be=function(e){var t=function(e){(0,c.Z)(i,e);var t=(0,h.Z)(i);function i(){var e;return(0,s.Z)(this,i),(e=t.apply(this,arguments)).controller=null,e.updatePolicy=me.j.SYNC,e.suspendResumeExtentMode="computed",e.slicePlaneEnabled=!1,e.fullExtentInLocalViewSpatialReference=null,e.suspendResumeExtent=null,e._controllerCreated=!1,e.supportsHeightUnitConversion=!0,e._pendingController=null,e.queryEngine=null,e}return(0,u.Z)(i,[{key:"initialize",value:function(){var e=this,t=this.layer;if("isTable"in t&&t.isTable)this.addResolvingPromise(Promise.reject(new p.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:t})));else{this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add((function(){return e.layer.renderer}),(function(t){return e._recreateProcessor(t)}),y.nn),this.addResolvingPromise((0,a.Z)((0,n.Z)().mark((function t(){var i;return(0,n.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,je.E)(e);case 2:return i=t.sent,e.fullExtentInLocalViewSpatialReference=i,t.next=6,e._initializeController();case 6:case"end":return t.stop()}}),t)})))()),this.updatingHandles.add((function(){return e.updatePolicy}),(function(t){return e.processor.preferredUpdatePolicy=t}));this.queryEngine=new E.q({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return e.processor.featureStore},hasZ:this.hasZ,hasM:this.hasM},priority:We.T8.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")}}},{key:"destroy",value:function(){this._destroyPendingController(),this.controller=(0,f.SC)(this.controller),this._set("processor",(0,f.SC)(this.processor)),this.queryEngine=(0,f.SC)(this.queryEngine),this.loadedGraphics=null}},{key:"_destroyPendingController",value:function(){this._pendingController=(0,f.SC)(this._pendingController)}},{key:"legendEnabled",get:function(){var e;return this.canResume()&&(null===(e=this.processor)||void 0===e?void 0:e.legendEnabled)}},{key:"graphics3DProcessor",get:function(){var e;return"graphics-3d"===(null===(e=this.processor)||void 0===e?void 0:e.type)?this.processor:null}},{key:"heatmapProcessor",get:function(){var e;return"heatmap"===(null===(e=this.processor)||void 0===e?void 0:e.type)?this.processor:null}},{key:"symbologySnappingSupported",get:function(){var e,t,i,r=null===(e=this.layer)||void 0===e||null===(t=e.renderer)||void 0===t?void 0:t.getSymbols();return null!==(i=null===r||void 0===r?void 0:r.some(F.QL))&&void 0!==i&&i}},{key:"getHit",value:function(e){var t,i,r=this;return null!==(t=this.loadedGraphics)&&void 0!==t&&t.forEach((function(t){t.uid===e&&(i=(0,m.mW)(t,r.layer))})),i?{type:"graphic",graphic:i,layer:i.layer}:null}},{key:"whenGraphicBounds",value:function(e,t){var i;return null===(i=this.processor)||void 0===i?void 0:i.whenGraphicBounds(e,t)}},{key:"computeAttachmentOrigin",value:function(e,t){var i;return null===(i=this.processor)||void 0===i?void 0:i.computeAttachmentOrigin(e,t)}},{key:"elevationAlignPointsInFeatures",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i){var r;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.graphics3DProcessor,!(0,f.Wi)(r)){e.next=3;break}throw new p.Z("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");case 3:return e.abrupt("return",(0,C.W)(this.view,this.layer,(function(e){return r.getGraphics3DGraphicByObjectId(e)}),t,i));case 4:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"queryForSymbologySnapping",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.symbologySnappingSupported?(0,k.c)(this.graphics3DProcessor,t,i):{candidates:[],sourceCandidateIndices:[]});case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"queryFeatures",value:function(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),(0,f.U2)(t,"signal"))}},{key:"queryObjectIds",value:function(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),(0,f.U2)(t,"signal"))}},{key:"queryFeatureCount",value:function(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),(0,f.U2)(t,"signal"))}},{key:"queryExtent",value:function(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),(0,f.U2)(t,"signal"))}},{key:"_ensureQuery",value:function(e){return(0,f.Wi)(e)?this.createQuery():b.Z.from(e)}},{key:"highlight",value:function(e){return this.processor.highlight(e,this.layer.objectIdField)}},{key:"maskOccludee",value:function(e){return this.processor.maskOccludee(e)}},{key:"canResume",value:function(){var e;return(0,o.Z)((0,l.Z)(i.prototype),"canResume",this).call(this)&&!(null!==(e=this.processor)&&void 0!==e&&e.scaleVisibilitySuspended)}},{key:"getSuspendInfo",value:function(){var e=(0,o.Z)((0,l.Z)(i.prototype),"getSuspendInfo",this).call(this);return this.processor?(0,r.Z)((0,r.Z)({},e),this.processor.suspendInfo):e}},{key:"isUpdating",value:function(){var e,t,i;return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&(null===(e=this.controller)||void 0===e||!e.updating)&&null!==(t=this.view)&&void 0!==t&&null!==(i=t.basemapTerrain)&&void 0!==i&&i.ready&&!this.processor.updating)}},{key:"_initializeController",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(){var t;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.createController(),this._pendingController=t,e.next=4,t.when();case 4:this._setControllerWhenInitialized(t);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_setControllerWhenInitialized",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var i=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.when();case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:if(this._controllerCreated=!0,this.notifyChange("updating"),!this.isResolved()||this.destroyed){e.next=19;break}return e.next=12,(0,y.N1)((function(){var e,t;return null===(e=i.view)||void 0===e||null===(t=e.basemapTerrain)||void 0===t?void 0:t.ready}));case 12:this.beforeSetController(t),this._pendingController=null,this.controller=t,this.loadedGraphics=t.graphics,this.notifyChange("updating"),e.next=20;break;case 19:this._destroyPendingController();case 20:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateClippingExtent",value:function(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}},{key:"_validateGeometryType",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=this.layer.geometryType,e.next="multipatch"===e.t0||"multipoint"===e.t0?3:4;break;case 3:throw new p.Z("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType});case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_recreateProcessor",value:function(e){var t,i,r=this,n="heatmap"===(null===e||void 0===e?void 0:e.type),a="heatmap"===(null===(t=this.processor)||void 0===t?void 0:t.type),s=this.processor;if(!s||n!==a){var u=n?new ze({owner:this}):new x.Z({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:function(e){return r._updateClippingExtent(e)}});this._set("processor",u),null!==s&&void 0!==s&&s.destroy(),null!==(i=this.queryEngine)&&void 0!==i&&i.clear(),this.addResolvingPromise(u.initializePromise)}}},{key:"_getResourceInfo",value:function(){var e,t,i=this.controller instanceof g.g?this.controller:null;return(0,r.Z)({displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:null!==(e=null===i||void 0===i?void 0:i.maximumNumberOfFeatures)&&void 0!==e?e:-1,totalNumberOfFeatures:null!==(t=null===i||void 0===i?void 0:i.serviceDataCount)&&void 0!==t?t:-1,nodes:0},this.processor.performanceInfo)}},{key:"performanceInfo",get:function(){return this._getResourceInfo()}}]),i}(e);return(0,d._)([(0,_.Cb)()],t.prototype,"loadedGraphics",void 0),(0,d._)([(0,_.Cb)()],t.prototype,"suspended",void 0),(0,d._)([(0,_.Cb)({readOnly:!0})],t.prototype,"legendEnabled",null),(0,d._)([(0,_.Cb)()],t.prototype,"updating",void 0),(0,d._)([(0,_.Cb)()],t.prototype,"controller",void 0),(0,d._)([(0,_.Cb)()],t.prototype,"processor",void 0),(0,d._)([(0,_.Cb)({readOnly:!0})],t.prototype,"updatePolicy",void 0),(0,d._)([(0,_.Cb)({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),(0,d._)([(0,_.Cb)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),(0,d._)([(0,_.Cb)({readOnly:!0})],t.prototype,"suspendInfo",void 0),(0,d._)([(0,_.Cb)()],t.prototype,"graphics3DProcessor",null),(0,d._)([(0,_.Cb)()],t.prototype,"heatmapProcessor",null),(0,d._)([(0,_.Cb)()],t.prototype,"symbologySnappingSupported",null),t=(0,d._)([(0,v.j)("esri.views.3d.layers.FeatureLikeLayerView3D")],t)}},53586:function(e,t,i){i.d(t,{Z:function(){return N}});var r=i(74165),n=i(15861),a=i(1413),s=i(15671),u=i(43144),o=i(60136),l=i(29388),c=i(27366),h=i(52639),d=i(23254),p=i(41644),f=i(41691),y=i(92026),_=i(66978),v=i(94172),m=i(49861),g=(i(25243),i(63780),i(69912)),b=i(48732),F=i(81753),C=i(58801),x=i(34610),E=i(86638),k=i(26279),T=i(61310),w=i(24181),R=i(57848),S=i(84328),Z=i(46568),O=i(59453),V=i(96387),D=i(99879),I=i(26511),P=i(68401),M=i(78485),A=function(e){(0,o.Z)(i,e);var t=(0,l.Z)(i);function i(e){var r;return(0,s.Z)(this,i),(r=t.call(this,e)).type="graphics-3d",r._randomRotationRenderers=null,r.elevationFeatureExpressionEnabled=!1,r.scaleVisibilityEnabled=!1,r.filterVisibilityEnabled=!1,r.frustumVisibilityEnabled=!1,r.elevationAlignmentEnabled=!1,r.timeExtentEnabled=!1,r.setUidToIdOnAdd=!0,r.dataExtent=null,r.drapeSourceType=k.Lw.Features,r.preferredUpdatePolicy=M.j.ASYNC,r._suspendResumeExtent=null,r}return(0,u.Z)(i,[{key:"initialize",value:function(){var e=this,t=this.owner,i=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&"multipatch"!==t.layer.geometryType,r=new w.w({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:t.hasZ,hasM:t.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:function(e){return t.view.deconflictor.addGraphicsOwner(e)},labeler:function(e,i){return t.view.labeler.addGraphicsOwner(e,i)},elevationAlignment:this.elevationAlignmentEnabled?function(i,r){return new R.Z({graphicsCoreOwner:e,graphicsCore:i,queryGraphicUIDsInExtent:r,elevationProvider:t.view.elevationProvider})}:null,scaleVisibility:this.scaleVisibilityEnabled?function(i,r){return new O.Z({graphicsCoreOwner:e,layer:e.layer,queryGraphicUIDsInExtent:r,graphicsCore:i,basemapTerrain:t.view.basemapTerrain})}:null,filterVisibility:i?function(e){return new I.n({context:(0,a.Z)({layerView:t},e)})}:null,objectStates:function(e){return new Z.d(e)}}});this._set("graphicsCore",r),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new S.Z({graphicsCoreOwner:this})),this.elevationAlignment&&this.updatingHandles.add((function(){return e.layer.elevationInfo}),(function(t,i){(0,b.Hg)(t,i)&&e.updatingHandles.addPromise(e.graphicsCore.elevationInfoChange())})),this.updatingHandles.add((function(){return e.layer.labelsVisible}),(function(){return e.graphicsCore.updateVisibilityInfo()})),this.updatingHandles.add((function(){return e.layer.labelingInfo}),(function(t,i){(0,b.Hg)(t,i)&&e.graphicsCore.updateLabelingInfo()})),this.updatingHandles.add((function(){return e.preferredUpdatePolicy}),(function(t){return e.graphicsCore.preferredUpdatePolicy=t})),this._set("initializePromise",this._initializeAsync()),this.updatingHandles.addPromise(this.initializePromise)}},{key:"_initializeAsync",value:function(){var e=(0,n.Z)((0,r.Z)().mark((function e(){var t,i=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_.U3)(this.graphicsCore.initializePromise);case 2:if(t=this.owner,this.updatingHandles.add((function(){return i.renderer}),(function(e){return i.updatingHandles.addPromise(i.graphicsCore.rendererChange(e))})),this.updatingHandles.add((function(){return t.fullOpacity}),(function(){return i.graphicsCore.opacityChange()})),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this.updatingHandles.add((function(){return t.view.clippingArea}),(function(){return i._updateClippingExtent()})),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),e.t0=this.graphicsCore.labelsEnabled,!e.t0){e.next=12;break}return e.next=12,(0,_.U3)(this.graphicsCore.updateLabelingInfo());case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",(0,y.SC)(this.frustumVisibility)),this._set("graphicsCore",(0,y.SC)(this.graphicsCore)),this._set("owner",null)}},{key:"layer",get:function(){return this.owner.layer}},{key:"renderer",get:function(){var e=this.layer,t=e.renderer,i=e.objectIdField;if(!t||!i||"heatmap"===t.type||!t.visualVariables)return t;var r=t.visualVariables.findIndex((function(e){return"rotation"===e.type&&null!=e.valueExpression&&(0,C.v)(e.valueExpression)===i&&(null==e.axis||"heading"===e.axis)&&"geographic"===e.rotationType}));if(r<0)return t;var n=t.clone();return n.visualVariables.splice(r,1),this._randomRotationRenderers||(this._randomRotationRenderers=new WeakMap),this._randomRotationRenderers.set(n,i),n}},{key:"scaleVisibility",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.scaleVisibility}},{key:"filterVisibility",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.filterVisibility}},{key:"elevationAlignment",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.elevationAlignment}},{key:"objectStates",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.objectStates}},{key:"suspendResumeExtentMode",get:function(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}},{key:"scaleVisibilitySuspended",get:function(){return(0,y.pC)(this.scaleVisibility)&&this.scaleVisibility.suspended}},{key:"suspended",get:function(){return this.owner.suspended}},{key:"legendEnabled",get:function(){return(0,y.Wi)(this.frustumVisibility)||!this.frustumVisibility.suspended}},{key:"suspendInfo",get:function(){var e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),(0,y.pC)(this.frustumVisibility)&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}},{key:"updating",get:function(){var e,t;return!!(null!==(e=this.graphicsCore)&&void 0!==e&&e.updating||(0,y.pC)(this.frustumVisibility)&&this.frustumVisibility.updating||null!==(t=this.updatingHandles)&&void 0!==t&&t.updating)}},{key:"updatingRemaining",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.updatingRemaining)&&void 0!==e?e:0}},{key:"featureStore",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.featureStore}},{key:"view",get:function(){return this.owner.view}},{key:"loadedGraphics",get:function(){return this.owner.loadedGraphics}},{key:"fullOpacity",get:function(){var e;return null===(e=this.owner)||void 0===e?void 0:e.fullOpacity}},{key:"filter",get:function(){return"filter"in this.owner?this.owner.filter:null}},{key:"slicePlaneEnabled",get:function(){return this.owner.slicePlaneEnabled}},{key:"updatePolicy",get:function(){return this.owner.updatePolicy}},{key:"featureSpatialReference",get:function(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}},{key:"graphics3DGraphics",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.graphics3DGraphics}},{key:"graphics3DGraphicsByObjectID",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.graphics3DGraphicsByObjectID}},{key:"symbolUpdateType",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.symbolUpdateType}},{key:"displayFeatureLimit",get:function(){var e,t=this.view.resourceController.memoryController.memoryFactor,i=null===(e=this.graphicsCore)||void 0===e?void 0:e.displayFeatureLimit;if(1===t)return i;var r=Math.ceil(i.maximumNumberOfFeatures*t),n=Math.ceil(i.maximumTotalNumberOfFeatures*t),s=Math.ceil(i.minimumTotalNumberOfFeatures*t);return(0,a.Z)((0,a.Z)({},i),{},{maximumNumberOfFeatures:r,maximumTotalNumberOfFeatures:n,minimumTotalNumberOfFeatures:s})}},{key:"usedMemory",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}},{key:"loadedFeatures",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.numberOfGraphics)&&void 0!==e?e:0}},{key:"usedMemoryPerFeature",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.usedMemoryPerGraphic)&&void 0!==e?e:0}},{key:"unprocessedMemoryEstimate",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.unprocessedMemoryEstimate)&&void 0!==e?e:0}},{key:"performanceInfo",get:function(){return{core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:(0,y.Wi)(this.frustumVisibility)||!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibilitySuspended}}},{key:"maskOccludee",value:function(e){var t=this.objectStates.acquireSet(P.V_.MaskOccludee,null),i=t.set,r=t.handle;return this.objectStates.setUid(i,e.uid),r}},{key:"highlight",value:function(e,t){var i=this;if(e instanceof E.Z){var r=this.objectStates.acquireSet(P.V_.Highlight,t),n=r.set,a=r.handle;return this.owner.queryObjectIds(e).then((function(e){return i.objectStates.setObjectIds(n,e)})),a}if("number"==typeof e||"string"==typeof e)return this.highlight([e],t);if(e instanceof h.Z)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof h.Z){var s=e;if(null==(0,D.g)(this.layer.fieldsIndex,s[0].attributes,t)){var u=s.map((function(e){return e.uid})),o=this.objectStates.acquireSet(P.V_.Highlight,null),l=o.set,c=o.handle;return this.objectStates.setUids(l,u),c}e=s.map((function(e){return(0,D.g)(i.layer.fieldsIndex,e.attributes,t)}))}if("number"==typeof e[0]||"string"==typeof e[0]){var d=e,p=this.objectStates.acquireSet(P.V_.Highlight,t),f=p.set,y=p.handle;return this.objectStates.setObjectIds(f,d),y}}return L}},{key:"resetObjectStates",value:function(){this.objectStates.reset()}},{key:"whenGraphicBounds",value:function(e,t){var i;return null===(i=this.graphicsCore)||void 0===i?void 0:i.whenGraphicBounds(e,t)}},{key:"computeAttachmentOrigin",value:function(e,t){var i;return null===(i=this.graphicsCore)||void 0===i?void 0:i.computeAttachmentOrigin(e,t)}},{key:"notifyGraphicGeometryChanged",value:function(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}},{key:"notifyGraphicVisibilityChanged",value:function(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}},{key:"getRenderingInfo",value:function(e,t,i){var r,n=(0,x.Kb)(e,{renderer:t,arcade:i});if((0,y.pC)(n)&&n.color){var a=n.color;a[0]=a[0]/255,a[1]=a[1]/255,a[2]=a[2]/255}if((0,y.pC)(n)&&(0,y.pC)(t)&&null!==(r=this._randomRotationRenderers)&&void 0!==r&&r.has(t)){var s=this._randomRotationRenderers.get(t),u=e.attributes[s],o=new d.a(0);o.updateFloatArray([u]),o.updateUint8Array([173]),n.heading=8.381e-8*o.digest()}return n}},{key:"getRenderingInfoAsync",value:function(e,t,i,r){return(0,x.xn)(e,(0,a.Z)({renderer:t,arcade:i},r))}},{key:"getSymbolLayerSize",value:function(e,t){var i;return null===(i=this.graphicsCore)||void 0===i?void 0:i.getSymbolLayerSize(e,t)}},{key:"setObjectIdVisibility",value:function(e,t){var i;null===(i=this.graphicsCore)||void 0===i||i.setObjectIdVisibility(e,t)}},{key:"refreshFilter",value:function(){(0,y.pC)(this.filterVisibility)&&this.filterVisibility.reapply()}},{key:"getGraphics3DGraphicByObjectId",value:function(e){var t;return null===(t=this.graphicsCore)||void 0===t?void 0:t.getGraphics3DGraphicByObjectId(e)}},{key:"_updateClippingExtent",value:function(){var e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}},{key:"_setupSuspendResumeExtent",value:function(){var e=this;(this.frustumVisibility||this.scaleVisibility)&&this.handles.add((0,v.YP)((function(){return e.suspendResumeExtentMode}),(function(){switch(e.handles.remove(U),e.suspendResumeExtentMode){case"computed":e.handles.add([(0,v.YP)((function(){return e.graphicsCore.computedExtent}),(function(t){return e._updateSuspendResumeExtent(t)}),v.nn),(0,v.YP)((function(){return e.graphicsCore.extentPadding}),(function(){return e._updateSuspendResumeExtent(e.graphicsCore.computedExtent)}))],U);break;case"data":e.handles.add([(0,v.gx)((function(){return e.dataExtent}),(function(t){return e._updateSuspendResumeExtent(t)}),v.nn),(0,v.YP)((function(){return e.graphicsCore.extentPadding}),(function(){return e._updateSuspendResumeExtent((0,y.Wg)(e.dataExtent))}))],U);break;default:(0,p.Bg)(e.suspendResumeExtentMode)}}),v.nn))}},{key:"_updateSuspendResumeExtent",value:function(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}},{key:"_extentToSuspendResumeRect",value:function(e,t){var i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!(0,F.Q8)(e,i))return;e=(0,F.iV)(e,i)}return(0,V.Go)(e,t,T.Z,this.graphicsCore.extentPadding)}},{key:"_suspendResumeExtentChanged",value:function(e){(0,y.pC)(this.frustumVisibility)&&this.frustumVisibility.setExtent(e),(0,y.pC)(this.scaleVisibility)&&this.scaleVisibility.setExtent(e)}}]),i}(f.r);(0,c._)([(0,m.Cb)()],A.prototype,"type",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"owner",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"layer",null),(0,c._)([(0,m.Cb)()],A.prototype,"renderer",null),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"updateClippingExtent",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"elevationFeatureExpressionEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"graphicsCore",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"scaleVisibilityEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"filterVisibilityEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"frustumVisibilityEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"elevationAlignmentEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"timeExtentEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"setUidToIdOnAdd",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"scaleVisibility",null),(0,c._)([(0,m.Cb)()],A.prototype,"filterVisibility",null),(0,c._)([(0,m.Cb)()],A.prototype,"elevationAlignment",null),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"frustumVisibility",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"objectStates",null),(0,c._)([(0,m.Cb)()],A.prototype,"initializePromise",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"suspendResumeExtentMode",null),(0,c._)([(0,m.Cb)()],A.prototype,"dataExtent",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"scaleVisibilitySuspended",null),(0,c._)([(0,m.Cb)()],A.prototype,"suspended",null),(0,c._)([(0,m.Cb)()],A.prototype,"legendEnabled",null),(0,c._)([(0,m.Cb)()],A.prototype,"suspendInfo",null),(0,c._)([(0,m.Cb)()],A.prototype,"updating",null),(0,c._)([(0,m.Cb)()],A.prototype,"updatingRemaining",null),(0,c._)([(0,m.Cb)()],A.prototype,"featureStore",null),(0,c._)([(0,m.Cb)()],A.prototype,"view",null),(0,c._)([(0,m.Cb)()],A.prototype,"loadedGraphics",null),(0,c._)([(0,m.Cb)()],A.prototype,"fullOpacity",null),(0,c._)([(0,m.Cb)()],A.prototype,"filter",null),(0,c._)([(0,m.Cb)()],A.prototype,"slicePlaneEnabled",null),(0,c._)([(0,m.Cb)()],A.prototype,"drapeSourceType",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"updatePolicy",null),(0,c._)([(0,m.Cb)()],A.prototype,"preferredUpdatePolicy",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"displayFeatureLimit",null);var N=A=(0,c._)([(0,g.j)("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],A),U="suspendResumeExtentMode",L={remove:function(){},pause:function(){},resume:function(){}}},82607:function(e,t,i){i.d(t,{q:function(){return F}});var r=i(1413),n=i(74165),a=i(15861),s=i(15671),u=i(43144),o=i(60136),l=i(29388),c=i(27366),h=(i(59486),i(85015)),d=i(92026),p=i(49861),f=(i(25243),i(63780),i(69912)),y=i(53866),_=i(14e3),v=i(49818),m=i(86638),g=i(27823),b=_.q,F=function(e){(0,o.Z)(i,e);var t=(0,l.Z)(i);function i(e){var r;return(0,s.Z)(this,i),(r=t.call(this,e))._dataQueryEngineInstance=null,r}return(0,u.Z)(i,[{key:"layer",get:function(){return this.context.layer}},{key:"spatialReference",get:function(){return this.context.spatialReference}},{key:"_queryGeometryType",get:function(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}},{key:"defaultQueryJSON",get:function(){return new m.Z({outSpatialReference:this.spatialReference}).toJSON()}},{key:"_dataQueryEngine",get:function(){return this._ensureDataQueryEngine()}},{key:"destroy",value:function(){this.clear()}},{key:"clear",value:function(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}},{key:"executeQueryForIdSet",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i,r){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(t,i),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"executeQueryForCount",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(t),i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQueryForExtent",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i){var r,a,s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(t),i);case 2:return r=e.sent,a=r.count,s=r.extent,e.abrupt("return",{count:a,extent:y.Z.fromJSON(s)});case 6:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQueryForIds",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(t),i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQueryForLatestObservations",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i){var r,a,s=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(t),i);case 2:return r=e.sent,a=v.Z.fromJSON(r),e.abrupt("return",(a.features.forEach((function(e){e.layer=s.layer,e.sourceLayer=s.layer})),a));case 5:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQuery",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i){var r,a,s=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._dataQueryEngine.executeQuery(this._ensureQueryJSON(t),i);case 2:return r=e.sent,a=v.Z.fromJSON(r),e.abrupt("return",(a.features.forEach((function(e){e.layer=s.layer,e.sourceLayer=s.layer})),a));case 5:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_ensureQueryJSON",value:function(e,t){var i=this.defaultQueryJSON;if((0,d.pC)(e)&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),i=e.toJSON()),(0,d.pC)(t)){var n=t.geometries.map((function(e){return e.toJSON()})).reduce((function(e,t){return e.rings=e.rings.concat(t.rings),e}));i=(0,r.Z)((0,r.Z)({},i),{},{sceneFilter:(0,r.Z)((0,r.Z)({},t),{},{geometry:n})})}return i}},{key:"_ensureDataQueryEngine",value:function(){var e,t;if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;var i="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,r=this.layer.objectIdField,n=g.M.toJSON(this._queryGeometryType),a=null!==(e=null===(t=this.layer.fields)||void 0===t?void 0:t.map((function(e){return e.toJSON()})))&&void 0!==e?e:[],s=this.priority,u=this.spatialReference.toJSON(),o=this.context,l=o.hasZ,c=o.hasM,h=o.featureStore,d=o.scheduler;return this._dataQueryEngineInstance=new b({hasZ:l,hasM:c,geometryType:n,fields:a,timeInfo:i,spatialReference:u,objectIdField:r,featureStore:h,scheduler:d,priority:s}),this._dataQueryEngineInstance}}]),i}(h.Z);(0,c._)([(0,p.Cb)({constructOnly:!0})],F.prototype,"context",void 0),(0,c._)([(0,p.Cb)({constructOnly:!0})],F.prototype,"priority",void 0),(0,c._)([(0,p.Cb)()],F.prototype,"layer",null),(0,c._)([(0,p.Cb)()],F.prototype,"spatialReference",null),(0,c._)([(0,p.Cb)()],F.prototype,"_queryGeometryType",null),(0,c._)([(0,p.Cb)()],F.prototype,"defaultQueryJSON",null),F=(0,c._)([(0,f.j)("esri.views.3d.layers.graphics.QueryEngine")],F)},32080:function(e,t,i){i.d(t,{j:function(){return L},A:function(){return H}});var r,n=i(37762),a=i(74165),s=i(15861),u=i(15671),o=i(43144),l=i(60136),c=i(29388),h=i(27366),d=i(85015),p=i(100),f=i(32718),y=i(77427),_=i(92026),v=i(66978),m=i(94172),g=i(99346),b=i(49861),F=(i(25243),i(63780)),C=i(69912),x=i(65156),E=i(65618),k=i(94618),T=i(86638),w=i(50951),R=(i(59896),i(93169),i(78952),i(41414),i(16889),i(53866),i(32238),i(77577),i(585),i(80885),i(29909),i(27823),i(83040),i(70178)),S=function(){function e(t,i){(0,u.Z)(this,e),this._highestResolutionVersion=null,this.versions=[],this.ref(t,i)}return(0,o.Z)(e,[{key:"isReferenced",get:function(){return 0!==this.versions.length}},{key:"isSingle",get:function(){return 1===this.versions.length&&1===this.versions[0].refCount}},{key:"ref",value:function(e,t){var i=this.feature;O.oldVersion=i,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0});var r,a=(0,n.Z)(this.versions);try{for(a.s();!(r=a.n()).done;){var s=r.value;if(s.resolution===t){s.refCount++;var u=this._highestResolutionVersion===s&&!(0,R.f)(e,s.feature);return(u||this._highestResolutionVersion!==s)&&(s.feature=e),O.newVersion=u?e:i,O}}}catch(l){a.e(l)}finally{a.f()}var o={feature:e,resolution:t,refCount:1};return this.versions.push(o),!this._highestResolutionVersion||t<this._highestResolutionVersion.resolution?(O.newVersion=e,this._highestResolutionVersion=o):O.newVersion=i,O}},{key:"unref",value:function(e){for(var t=0;t<this.versions.length;t++){var i=this.versions[t];if(i.resolution===e)return i.refCount--,O.oldVersion=this.feature,0===i.refCount&&(this.versions[t]=this.versions[this.versions.length-1],this.versions.length--,this._highestResolutionVersion===i&&(this._recalculateHighestResolutionVersion(),O.oldVersion=i.feature)),O.newVersion=this.feature,O}return null}},{key:"feature",get:function(){return this._highestResolutionVersion?this._highestResolutionVersion.feature:null}},{key:"_recalculateHighestResolutionVersion",value:function(){if(0!==this.versions.length){for(var e=this.versions[0],t=1;t<this.versions.length;t++){var i=this.versions[t];i.resolution<e.resolution&&(e=i)}this._highestResolutionVersion=e}else this._highestResolutionVersion=null}}]),e}(),Z=function(){function e(t){(0,u.Z)(this,e),this._feature=t,this._refCount=1}return(0,o.Z)(e,[{key:"isReferenced",get:function(){return 0!==this._refCount}},{key:"isSingle",get:function(){return 1===this._refCount}},{key:"ref",value:function(e){return++this._refCount,O.oldVersion=this._feature,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0}),(0,R.f)(this._feature,e)||(this._feature=e),O.newVersion=this._feature,O}},{key:"unref",value:function(){return O.oldVersion=this._feature,this._refCount>0&&(this._refCount--,!this.isReferenced)?(O.newVersion=null,O):(O.newVersion=this._feature,O)}},{key:"feature",get:function(){return this._feature}}]),e}(),O={oldVersion:null,newVersion:null},V=new Set,D=function(){function e(t){(0,u.Z)(this,e),this.descriptor=t,this.fetchStatus=r.FETCH_NEEDED,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=I,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=V,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}return(0,o.Z)(e,[{key:"displayingFeatures",get:function(){return this._displayingFeatures},set:function(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}},{key:"perTileMaximumNumberOfFeaturesExceeded",get:function(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}},{key:"features",get:function(){return this._features}},{key:"featureLimit",get:function(){return this._featureLimit},set:function(e){this._featureLimit!==e&&(this._featureLimit=e,this._estimatedUnusedSizeDirty=!0)}},{key:"availableFields",get:function(){return this._availableFields}},{key:"setFeatures",value:function(e,t,i){this._availableFields=(0,_.Pt)(i,V),this._features=e,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,e&&e.length>0?(this._emptyFeatureRatio=t/(e.length+t),this._numVertices=e.reduce((function(e,t){return e+(0,E.R3)(t.geometry)}),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}},{key:"emptyFeatureRatio",get:function(){return this._emptyFeatureRatio}},{key:"numFeatures",get:function(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0},set:function(e){this._numFeatures=e}},{key:"hasPreciseFeatureCount",get:function(){return this._numFeatures>I}},{key:"needsFeatureCount",get:function(){return this._numFeatures===I}},{key:"numVertices",get:function(){return this._numVertices}},{key:"id",get:function(){return this.descriptor.id}},{key:"estimatedSize",get:function(){return this.updateMemoryEstimates(),this._estimatedSize}},{key:"estimatedUnusedSize",get:function(){return this._estimatedUnusedSize}},{key:"updateMemoryEstimates",value:function(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(var e=0;e<this._features.length;++e){var t=(0,E.Xw)(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(var i=this.featureLimit;i<this._features.length;++i)this._estimatedUnusedSize+=(0,E.Xw)(this._features[i]);return!0}return!1}},{key:"isFetching",get:function(){return this.fetchStatus===r.FETCHING||this.fetchStatus===r.REFETCHING}},{key:"isRefetching",get:function(){return this.fetchStatus===r.REFETCHING}},{key:"needsFetching",get:function(){return this.fetchStatus===r.FETCH_NEEDED||this.fetchStatus===r.REFETCH_NEEDED}},{key:"needsRefetching",get:function(){return this.fetchStatus===r.REFETCH_NEEDED}},{key:"isFetched",get:function(){return this.fetchStatus===r.DONE||this.fetchStatus===r.FULL}},{key:"resetFetching",value:function(){this.fetchStatus=this.fetchStatus===r.REFETCHING?r.REFETCH_NEEDED:r.FETCH_NEEDED}},{key:"needsDisplayUpdate",get:function(){return!!this._features&&!function(e,t,i){if((0,_.Wi)(t)||(0,_.Wi)(e)||i!==t.length||i>e.length)return!1;for(var r=0;r<i;++r)if(e[r]!==t[r])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}},{key:"intersects",value:function(e){return!(!(0,_.Wi)(e)&&this.descriptor.extent)||((0,x.oJ)(e,P),(0,x.kK)(this.descriptor.extent,P))}},{key:"intersectionIncludingBorrowed",value:function(e,t){var i=(0,_.pC)(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||i?((0,_.pC)(e)?((0,x.oJ)(e,t),(0,x.jV)(t,i,t)):(0,x.JG)(t,i),t):((0,x.JG)(t,x.bd),t)}},{key:"_shuffle",value:function(e){this._features.sort((function(t,i){return(0,E.MS)(t,e)-(0,E.MS)(i,e)})),(0,F.TV)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}},{key:"reduceFeatures",value:function(e,t,i){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;var n=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===r.DONE&&this._features.length>0&&(this.fetchStatus=r.REFETCH_NEEDED,n=!0)),!this._shuffled&&e<1&&this._shuffle(i);var a=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));return this._features.length>a&&(this._features.length=a,this.featuresMissing=!0,this.fetchStatus===r.FULL&&(this.fetchStatus=r.DONE)),n}},{key:"cache",get:function(){return{availableFields:this._availableFields,features:this._features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}},set:function(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._numFeatures=e.numFeatures,this._emptyFeatureRatio=e.emptyFeatureRatio,this.fetchStatus=e.fetchStatus,this.featuresMissing=e.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}]),e}(),I=-1;!function(e){e[e.FETCH_NEEDED=0]="FETCH_NEEDED",e[e.REFETCH_NEEDED=1]="REFETCH_NEEDED",e[e.FETCHING=2]="FETCHING",e[e.REFETCHING=3]="REFETCHING",e[e.DONE=4]="DONE",e[e.FULL=5]="FULL"}(r||(r={}));var P=(0,x.Ue)(),M=i(36734),A=i(93463),N="esri.views.3d.layers.support.FeatureTileFetcher3D",U=f.Z.getLogger(N),L=function(e){(0,l.Z)(i,e);var t=(0,c.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e))._useTileCount=!1,r.updating=!1,r.running=!1,r.updatingTotal=0,r.updatingRemaining=0,r.expectedFeatureDiff=0,r.maximumNumberOfFeaturesExceeded=!1,r.maximumNumberOfFeaturesExceededThrottle=1e3,r._fullRatio=1,r._farRatio=1,r._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},r._handles=new p.Z,r._frameTask=A.sq,r._dirty=!1,r._featureTiles=new Map,r._displayingFeatureReferences=new Map,r._numDisplayingFeatureReferences=0,r._suspended=!0,r._pendingEdits=null,r}return(0,o.Z)(i,[{key:"maximumNumberOfFeatures",set:function(e){e=e||1/0;var t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}},{key:"memoryFactor",set:function(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}},{key:"lodFactor",set:function(e){this.lodFactor!==e&&(this._set("lodFactor",e),this._supportsResolution&&this.refetch())}},{key:"useTileCount",get:function(){return this._useTileCount&&(0,_.pC)(this.context.query.queryFeatureCount)},set:function(e){this._useTileCount=e,this.notifyChange("useTileCount")}},{key:"memoryForUnusedFeatures",get:function(){var e=0;return this._featureTiles.forEach((function(t){return e+=t.estimatedUnusedSize})),e}},{key:"totalVertices",get:function(){var e=0;return this._featureTiles.forEach((function(t){return e+=t.numVertices})),e}},{key:"totalFeatures",get:function(){var e=0;return this._featureTiles.forEach((function(t){return e+=t.numFeatures})),e}},{key:"filterExtent",set:function(e){if((0,_.pC)(e)&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))U.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");else{var t=this._get("filterExtent");if(!(t===e||(0,_.pC)(t)&&e&&t.equals(e))){var i=(0,_.pC)(e)?e.clone():null;this._set("filterExtent",i),this._reclip(i,t)}}}},{key:"initialize",value:function(){var e=this;this._handles.add((0,m.on)((function(){return e.tileDescriptors}),"change",(function(){return e._setDirty()}),{onListenerAdd:function(){return e._setDirty()}})),this._objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?S:Z;var t=this.context.scheduler;(0,_.pC)(t)&&(this._frameTask=t.registerTask(A.T8.FEATURE_TILE_FETCHER,this)),this._setDirty()}},{key:"destroy",value:function(){var e,t=this;this._frameTask.remove(),this._handles=(0,_.SC)(this._handles),this._featureTiles.forEach((function(e){t._cancelFetchTile(e),t._removeTile(e)})),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),null!==(e=this._pendingEdits)&&void 0!==e&&e.controller.abort(),this._pendingEdits=null}},{key:"_paused",get:function(){return this._suspended||!!this._pendingEdits}},{key:"restart",value:function(){var e=this;this._featureTiles.forEach((function(t){e._cancelFetchTile(t),e._clearTile(t),e._resetFetchTile(t)})),(0,_.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}},{key:"refetch",value:function(){var e=this;this._featureTiles.forEach((function(t){e._cancelFetchTile(t),e._resetFetchTile(t)})),(0,_.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}},{key:"suspend",value:function(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}},{key:"resume",value:function(){this._suspended&&(this._suspended=!1,this._unpause())}},{key:"_pause",value:function(){var e=this;this._paused&&(this._featureTiles.forEach((function(t){return e._cancelFetchTile(t)})),this._updated())}},{key:"_unpause",value:function(){this._paused||(this._setDirty(),this._updated())}},{key:"availableFields",get:function(){var e=null;return this._featureTiles.forEach((function(t){(0,_.Wi)(t.displayingFeatures)||0===t.displayingFeatures.length||((0,_.Wi)(e)?e=new Set(t.availableFields):e.forEach((function(i){t.availableFields.has(i)||(0,_.Wg)(e).delete(i)})))})),(0,_.pC)(e)?e:new Set}},{key:"applyEdits",value:function(e){var t=this;this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());var i=this._pendingEdits;i.count++;var r=i.edits.then((function(){return e.result.catch((function(e){if((0,v.D_)(e))throw e;return null})).then((function(e){return e?(t._applyEditsDeleteFeatures(e.deletedFeatures),t._applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,i.controller.signal).then((function(){return e}))):e})).then((function(e){return 0==--i.count&&(t._pendingEdits===i&&(t._pendingEdits=null),(0,_.pC)(t.context.memoryCache)&&t.context.memoryCache.clear(),t._unpause(),t._updated()),e}))}));return i.edits=r,this._updated(),r}},{key:"_applyEditsDeleteFeatures",value:function(e){var t=this;if(0!==e.length){var i=this.context.globalIdField,r=i&&this.availableFields.has(i),n=new Set,a=this._objectIdField;e.forEach((function(e){var s=e.objectId,u=e.globalId;if((!s||s<0)&&i){r||U.errorOncePerTick("Editing the specified service requires the layer's globalIdField, ".concat(i," to be included the layer's outFields for updates to be reflected in the view"));var o=t.features.find((function(e){return e.attributes&&e.attributes[i]===u}));o&&n.add((0,E.MS)(o,a))}else n.add(s)})),this._featureTiles.forEach((function(e){if(e.features){var i=e.features.filter((function(e){return!n.has((0,E.MS)(e,t._objectIdField))}));i.length!==e.features.length&&(e.setFeatures(i,0,e.availableFields),t._invalidateCounts())}}))}}},{key:"_applyEditsAddUpdateFeatures",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i,r){var n,s,u,o=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=[],s=new Set,t.forEach((function(e){return n.push(e.objectId)})),i.forEach((function(e){n.push(e.objectId),s.add(e.objectId)})),0!==n.length){e.next=3;break}return e.abrupt("return");case 3:return u=[],this._featureTiles.forEach((function(e){var t=o._applyEditsAddUpdateTile(e,n,s,r);t&&u.push(t)})),e.next=7,(0,v.as)(u);case 7:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_applyEditsAddUpdateTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i,r,s){var u,o,l,c,h,d,p,f=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.features){e.next=2;break}return e.abrupt("return");case 2:return(u=this._createQuery(t)).resultType=void 0,u.cacheHint=!1,u.objectIds=i,e.next=6,this._queryFeatures(u,s);case 6:if(o=e.sent,l=null,r.size>0&&(c=t.features.filter((function(e){return!r.has((0,E.MS)(e,f._objectIdField))}))).length!==t.features.length&&(l=c),o.features.length>0){l||(l=t.features.slice()),h=(0,n.Z)(o.features);try{for(h.s();!(d=h.n()).done;)p=d.value,l.push(p)}catch(a){h.e(a)}finally{h.f()}}l&&(t.hasPreciseFeatureCount&&(t.numFeatures=Math.max(t.numFeatures,l.length)),t.setFeatures(l,0,j(t.availableFields,o.fields)),this._invalidateCounts());case 11:case"end":return e.stop()}}),e,this)})));return function(t,i,r,n){return e.apply(this,arguments)}}()},{key:"_queryFeatures",value:function(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:X})}},{key:"_setDirty",value:function(){this._dirty=!0,this._updated()}},{key:"runTask",value:function(e){var t=this;if(this._frameTask.processQueue(e),this._dirty&&this.initialized){this._dirty=!1;var i=this._getListOfTiles();if(this._markTilesNotAlive(i),e.run((function(){return t._addTiles(i,e)}))&&e.run((function(){return t._filterExtentTiles(i,e)}))&&e.run((function(){return t._removeTiles(i,e)}))&&!e.done){var r=this._sortTiles(i);e.run((function(){return t._showTiles(r,e)}))&&e.run((function(){return t._fetchTiles(r,e)}))&&e.run((function(){return t._updateMemoryEstimates(r,e)}))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}else this._setDirty()}}},{key:"_markTilesNotAlive",value:function(e){var t,i=(0,n.Z)(e);try{for(i.s();!(t=i.n()).done;){t.value.alive=!1}}catch(r){i.e(r)}finally{i.f()}}},{key:"_addTiles",value:function(e,t){var i=this;return!this._suspended&&(this.tileDescriptors.forEach((function(r){var n=i._featureTiles.get(r.id);n?n.alive=!0:t.done||(e.push(i._addTile(r)),t.madeProgress())})),t.hasProgressed)}},{key:"_filterExtentTiles",value:function(e,t){var i,r=(0,n.Z)(e);try{for(r.s();!(i=r.n()).done;){var a=i.value;if(t.done)break;a.alive&&(a.filtered=!a.intersects(this.filterExtent),a.filtered&&(this._clearTile(a),t.madeProgress()))}}catch(s){r.e(s)}finally{r.f()}return t.hasProgressed}},{key:"_removeTiles",value:function(e,t){for(var i=e.length-1;i>=0&&!t.done;i--){var r=e[i];r.alive||(this._removeTile(r),i!==e.length-1&&(e[i]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}},{key:"_sortTiles",value:function(e){return e.sort((function(e,t){var i,r;return(null!==(i=e.descriptor.loadPriority)&&void 0!==i?i:0)-(null!==(r=t.descriptor.loadPriority)&&void 0!==r?r:0)})),e}},{key:"_showTiles",value:function(e,t){var i,r=this,a=this._updateRatio(e),s=(0,n.Z)(e);try{var u=function(){var e=i.value;if(!t.run((function(){return function(e){var t=r._fullRatio<1?a(e)*r._farRatio:1;return e.reduceFeatures(t,r.memoryFactor,r._objectIdField)&&r._setDirty(),r._showTile(e)}(e)})))return r._setDirty(),"break"};for(s.s();!(i=s.n()).done;){if("break"===u())break}}catch(o){s.e(o)}finally{s.f()}return t.hasProgressed}},{key:"_fetchTiles",value:function(e,t){var i=this;if(this._paused)return!1;var r,a=!1,s=(0,n.Z)(e);try{var u=function(){var e=r.value;if(!e.needsFetching)return"continue";var n=(0,_.pC)(i.context.memoryCache)?i.context.memoryCache.pop(e.id):null;if((0,_.pC)(n))e.cache=n,i._setDirty(),i._scheduleUpdated(),t.madeProgress();else{if(i._needsNumFeatures(e)){var s=new AbortController,u=i._fetchTileCount(e,s.signal);i._handleRequest(e,u,s,(function(){return e.numFeatures=-2})),a=!0,t.madeProgress()}if(t.done)return{v:!0}}};for(s.s();!(r=s.n()).done;){var o=u();if("continue"!==o&&"object"===typeof o)return o.v}}catch(p){s.e(p)}finally{s.f()}if(a)return t.hasProgressed;var l,c=(0,n.Z)(e);try{var h=function(){var e=l.value;if(e.needsFetching){var r=new AbortController,n=i._fetchTile(e,r.signal);if(i._handleRequest(e,n,r,(function(t){e.setFeatures([],0,null),i._invalidateCounts(),e.featuresMissing=!1,i.context.logFetchError(U,t)})),t.madeProgress())return{v:!0}}};for(c.s();!(l=c.n()).done;){var d=h();if("object"===typeof d)return d.v}}catch(p){c.e(p)}finally{c.f()}return t.hasProgressed}},{key:"_updateMemoryEstimates",value:function(e,t){var i=this;return e.some((function(e){return!t.run((function(){return e.updateMemoryEstimates()}))&&(i._setDirty(),!0)})),t.hasProgressed}},{key:"_reclip",value:function(e,t){if(this.initialized){var i=new Array;this._featureTiles.forEach((function(r){(0,_.Wi)(r.displayingFeatures)||0===r.displayingFeatures.length||(r.intersectionIncludingBorrowed(t,B),r.intersectionIncludingBorrowed(e,Y),(0,x.fS)(B,Y)||i.push(r))})),this._refreshDisplayingFeatures(i),this._updated()}}},{key:"_refreshDisplayingFeatures",value:function(e){var t,i=new Set,r=this._changes.updates,a=(0,n.Z)(e);try{for(a.s();!(t=a.n()).done;){var s=t.value;if(!(0,_.Wi)(s.displayingFeatures)){var u,o=(0,n.Z)(s.displayingFeatures);try{for(o.s();!(u=o.n()).done;){var l=u.value,c=(0,E.MS)(l,this._objectIdField);if(!i.has(c)){i.add(c);var h=this._displayingFeatureReferences.get(c).feature;r.removes.push(h),r.adds.push(h)}}}catch(d){o.e(d)}finally{o.f()}}}}catch(d){a.e(d)}finally{a.f()}this._applyChanges()}},{key:"_updated",value:function(){var e=this,t=0;this._paused||this._featureTiles.forEach((function(e){return e.isFetching?++t:0}));var i=this._dirty||!!this._pendingEdits||t>0;if(this._set("running",this._dirty),this._set("updating",i),i){var r=0,n=0,a=0,s=0,u=0,o=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach((function(t){if(++n,t.isFetching&&t.hasPreciseFeatureCount){var i=e._maximumFeaturesForTile(t)*(1-t.emptyFeatureRatio),l=(0,_.pC)(t.displayingFeatures)?t.displayingFeatures.length*o:0;u+=i-l}t.needsFetching?++s:t.numFeatures>0&&(++a,r+=t.numFeatures)})),s+=t;var l=0,c=0;r?(c=r,l=Math.min(s*r/a,r)):(c=n,l=s),u=Math.min(this.maximumNumberOfFeatures-this.features.length,u),this._set("updatingTotal",c),this._set("updatingRemaining",l),this._set("expectedFeatureDiff",u)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}},{key:"_updateMaximumNumberOfFeaturesExceeded",value:function(){var e=(0,y.oE)(this._featureTiles,(function(e){return e.perTileMaximumNumberOfFeaturesExceeded}));this._set("maximumNumberOfFeaturesExceeded",e)}},{key:"_updateRatio",value:function(e){var t,i=function(e){var t,i=0,r=(0,n.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.features&&a.features.length>0&&a.alive&&(i=Math.max(i,a.descriptor.lij[0]))}}catch(s){r.e(s)}finally{r.f()}return i}(e),r=function(e){return 1/(1<<Math.max(0,i-e.descriptor.lij[0]))},a=0,s=0,u=(0,n.Z)(e);try{for(u.s();!(t=u.n()).done;){var o=t.value,l=o.numFeatures;a+=l,s+=l*r(o)}}catch(c){u.e(c)}finally{u.f()}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/a),this._farRatio=this.maximumNumberOfFeatures/s,this._scheduleUpdated(),r}},{key:"_maximumFeaturesUpdated",value:function(e,t){var i=this;e!==t&&(t>e&&this._featureTiles.forEach((function(e){if(e.featuresMissing){var t=i._maximumFeaturesForTile(e);e.features&&(e.features.length>=t||e.fetchStatus===r.FULL)||(i._cancelFetchTile(e),i._resetFetchTile(e))}})),this._setDirty())}},{key:"_addTile",value:function(e){var t=new D(e);return this._featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}},{key:"_referenceDisplayingFeaturesFromRelatedTiles",value:function(e){var t=this,i=e.descriptor.resolution;this._featureTiles.forEach((function(r){if(!((0,_.Wi)(r.displayingFeatures)||e===r||e.descriptor.lij&&r.descriptor.lij&&!(0,M.E9)(e.descriptor.lij,r.descriptor.lij))){(0,_.Wi)(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&r.descriptor.extent&&((0,_.Wi)(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=(0,x.d9)(e.descriptor.extent)),(0,x.jn)(e.extentIncludingBorrowedFeatures,r.descriptor.extent,e.extentIncludingBorrowedFeatures));var a,s=(0,n.Z)(r.displayingFeatures);try{for(s.s();!(a=s.n()).done;){var u=a.value;e.displayingFeatures.push(u);var o=t._displayingFeatureReferences.get((0,E.MS)(u,t._objectIdField));o.ref(o.feature,i),t._numDisplayingFeatureReferences++}}catch(l){s.e(l)}finally{s.f()}}})),e.featureLimit=(0,_.pC)(e.displayingFeatures)?e.displayingFeatures.length:0}},{key:"_removeTile",value:function(e){this._clearTile(e),this._featureTiles.delete(e.id)}},{key:"_resetFetchTile",value:function(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=r.DONE):e.fetchStatus=r.FETCH_NEEDED}},{key:"_cancelFetchTile",value:function(e){var t=e.requestController;(0,_.pC)(t)&&(e.requestController=null,e.resetFetching(),t.abort())}},{key:"_fetchTileCount",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchCount(t,i);case 2:return t.numFeatures=e.sent,this._updateRatio(this._getListOfTiles()),e.abrupt("return",t.fetchStatus===r.REFETCHING?r.REFETCH_NEEDED:r.FETCH_NEEDED);case 5:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_fetchTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i){var n,s,u,o,l,c,h,d,p,f,y=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((n=this._maximumFeaturesForTile(t))<=0)){e.next=3;break}return e.abrupt("return",z(t));case 3:if(s=this._getMaxRecordCount(t),u=Math.ceil(n/s),!(G(t)||!this.context.capabilities.supportsMaxRecordCountFactor||t.numFeatures<=n&&u>T.Z.MAX_MAX_RECORD_COUNT_FACTOR)){e.next=6;break}return e.abrupt("return",this._fetchPagedTile(t,i));case 6:return(o=this._createQuery(t)).maxRecordCountFactor=Math.ceil(n/s),t.isRefetching&&t.features&&t.features.length>0&&(l=Math.ceil(t.features.length/(1-t.emptyFeatureRatio)/s),o.maxRecordCountFactor=Math.max(l+1,o.maxRecordCountFactor)),e.next=10,this._queryFeatures(o,i);case 10:return c=e.sent,h=c.features,d=c.exceededTransferLimit,p=c.fields,f=d?o.maxRecordCountFactor>=T.Z.MAX_MAX_RECORD_COUNT_FACTOR?r.FULL:r.DONE:r.FULL,e.next=17,this._frameTask.schedule((function(){t.featuresMissing=h.length<t.numFeatures||!!d;var e=y._removeEmptyFeatures(h);t.setFeatures(h,e,Q(p))}),i);case 17:return(0,v.k_)(i),this._invalidateCounts(),e.abrupt("return",f);case 20:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_fetchCount",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.context.query.queryFeatureCount(this._createFeatureCountQuery(t),{signal:i}));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_fetchPagedTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i){var n,s,u,o,l,c,h,d,p,f=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=0,u=0,o=0,l=this._maximumFeaturesForTile(t)-o,c=this._getMaxRecordCount(t),h=null,d=(0,a.Z)().mark((function e(){var d,p,y,m,g,b;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=f._createQuery(t),p=f._setPagingParameters(d,s,l,c),e.next=4,f._queryFeatures(d,i);case 4:return y=e.sent,m=y.features,g=y.exceededTransferLimit,b=y.fields,e.next=10,f._frameTask.schedule((function(){p&&(s+=(0,_.Wg)(d.num)),o+=m.length,u+=f._removeEmptyFeatures(m),t.featuresMissing=s<t.numFeatures||!!g,n=n?n.concat(m):m,h=j(h,b),t.setFeatures(n,u,h)}),i);case 10:if((0,v.k_)(i),f._invalidateCounts(),f._setDirty(),l=f._maximumFeaturesForTile(t)-o,p&&g&&!(l<=0)){e.next=16;break}return e.abrupt("return",{v:g?r.DONE:r.FULL});case 16:case"end":return e.stop()}}),e)}));case 4:return e.delegateYield(d(),"t0",5);case 5:if("object"!==typeof(p=e.t0)){e.next=8;break}return e.abrupt("return",p.v);case 8:e.next=4;break;case 10:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_createFeatureCountQuery",value:function(e){var t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}},{key:"_createQuery",value:function(e){var t=this.context.createQuery(),i=e.descriptor.extent;if(i){var r=this.context.tilingScheme.spatialReference;t.geometry=(0,x.HH)(i,r)}return this._setResolutionParams(t,e),this._useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}},{key:"_setPagingParameters",value:function(e,t,i,r){return!!this.context.capabilities.supportsPagination&&(e.start=t,i>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/r),e.num=Math.min(e.maxRecordCountFactor*r,i)):e.num=Math.min(r),!0)}},{key:"_getEffectiveTileResolution",value:function(e){if(null==e.descriptor.resolution)return null;var t=this.context.viewingMode===w.JY.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}},{key:"_supportsResolution",get:function(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}},{key:"_setResolutionParams",value:function(e,t){if(this._supportsResolution){var i=this._getEffectiveTileResolution(t);null!=i&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new k.Z({mode:"view",originPosition:"upper-left",tolerance:i,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=i))}}},{key:"_removeEmptyFeatures",value:function(e){for(var t=e.length,i=0;i<e.length;){var r=e[i];(0,E.dF)(r.geometry)?++i:(e[i]=e[e.length-1],--e.length)}return t-e.length}},{key:"_needsNumFeatures",value:function(e){return this.useTileCount&&e.needsFeatureCount&&!G(e)}},{key:"_getMaxRecordCount",value:function(e){var t=this.context,i=t.tileMaxRecordCount,r=t.maxRecordCount;return this._useTileQuery(e)&&(0,_.pC)(i)&&i>0&&this.context.capabilities.supportsResultType?i:(0,_.pC)(r)&&r>0?r:W}},{key:"_useTileQuery",value:function(e){return(!G(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}},{key:"_handleRequest",value:function(e,t,i,n){var a=this;e.fetchStatus=e.needsRefetching?r.REFETCHING:r.FETCHING,e.requestController=i;var s=!1;t.then((function(t){e.requestController=null,e.fetchStatus=t})).catch((function(t){e.requestController===i&&(e.requestController=null,e.fetchStatus=r.DONE),(0,v.D_)(t)?s=!0:n(t)})).then((function(){s||a._setDirty(),a._scheduleUpdated()}))}},{key:"_scheduleUpdated",value:function(){var e=this;this._handles&&!this._handles.has("scheduleUpdated")&&this._handles.add((0,g.Os)((function(){e._handles.remove("scheduleUpdated"),e._updated()})),"scheduleUpdated")}},{key:"_showTile",value:function(e){if((0,_.pC)(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;var t=e.features;if(0===e.featureLimit||!t){var i=(0,_.pC)(e.displayingFeatures)&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],i}var r=e.descriptor.resolution,n=this._changes.updates,a=this._changes.adds,s=Math.min(e.featureLimit,t.length);e.featureLimit=s;for(var u=0;u<s;++u){var o=t[u],l=(0,E.MS)(o,this._objectIdField),c=this._displayingFeatureReferences.get(l);if(c){var h=c.ref(o,r);h.oldVersion!==h.newVersion&&(h.oldVersion&&n.removes.push(h.oldVersion),h.newVersion&&n.adds.push(h.newVersion))}else this._displayingFeatureReferences.set(l,new this.FeatureReferenceClass(o,r)),a.push(o);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(e),this._applyChanges(),e.displayingFeatures=t.slice(0,s),!0}},{key:"_hideTile",value:function(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}},{key:"_hideTileFeatures",value:function(e){if(!(0,_.Wi)(e.displayingFeatures)){var t,i=this._changes.updates,r=this._changes.removes,a=(0,n.Z)(e.displayingFeatures);try{for(a.s();!(t=a.n()).done;){var s=t.value,u=(0,E.MS)(s,this._objectIdField),o=this._displayingFeatureReferences.get(u);if(o){var l=o.unref(e.descriptor.resolution);this._numDisplayingFeatureReferences--,l?l.oldVersion!==l.newVersion&&(null==l.newVersion?(this._displayingFeatureReferences.delete(u),l.oldVersion&&r.push(l.oldVersion)):(i.adds.push(l.newVersion),l.oldVersion&&i.removes.push(l.oldVersion))):console.error("Hiding unreferenced feature")}}}catch(c){a.e(c)}finally{a.f()}this._applyChanges(),e.displayingFeatures=null}}},{key:"_applyChanges",value:function(){var e=this._changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);for(var t=this._changes.adds,i=this._changes.removes,r=Math.min(t.length,i.length),n=0;n<r;){var a=Math.min(n+J,r);this.features.addMany(t.slice(n,a)),this.features.removeMany(i.slice(n,a)),n=a}t.length>r&&this.features.addMany(0===n?t:t.slice(n)),i.length>r&&this.features.removeMany(0===n?i:i.slice(n)),t.length=0,i.length=0}},{key:"_clearTile",value:function(e){if(this._hideTile(e),e.features&&(0,_.pC)(this.context.memoryCache)){var t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null),this._invalidateCounts()}},{key:"_invalidateCounts",value:function(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}},{key:"_getListOfTiles",value:function(){return Array.from(this._featureTiles.values())}},{key:"storedFeatures",get:function(){return this._getListOfTiles().reduce((function(e,t){return e+(t.features?t.features.length:0)}),0)}},{key:"missingTiles",get:function(){return Array.from(this._featureTiles.values()).reduce((function(e,t){return e+(t.needsFetching||t.isFetching?1:0)}),0)}},{key:"_maximumFeaturesForTile",value:function(e){var t=e.hasPreciseFeatureCount?e.numFeatures:1/0,i=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,r=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(i*r/(1-e.emptyFeatureRatio)),t)}},{key:"test",get:function(){var e=this;return{process:function(t){return e.runTask(t)},getFeatureTileById:function(t){return e._featureTiles.get(t)},forEachFeatureTile:function(t){return e._featureTiles.forEach(t)}}}}]),i}(d.Z);function G(e){return"dummy-tile-full-extent"===e.id}function H(e){var t=e.capabilities.query;return{supportsMultipleResolutions:q(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function q(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function z(e){return e.setFeatures([],0,null),e.featuresMissing=!1,r.DONE}function Q(e){return(0,_.Wi)(e)?new Set:new Set(e.map((function(e){return e.name})))}function j(e,t){if((0,_.Wi)(e)||(0,_.Wi)(t))return Q(t);var i,r=new Set,a=(0,n.Z)(t);try{for(a.s();!(i=a.n()).done;){var s=i.value.name;e.has(s)&&r.add(s)}}catch(u){a.e(u)}finally{a.f()}return r}(0,h._)([(0,b.Cb)({constructOnly:!0})],L.prototype,"features",void 0),(0,h._)([(0,b.Cb)()],L.prototype,"tileDescriptors",void 0),(0,h._)([(0,b.Cb)({value:1/0})],L.prototype,"maximumNumberOfFeatures",null),(0,h._)([(0,b.Cb)({value:1})],L.prototype,"memoryFactor",null),(0,h._)([(0,b.Cb)({value:1})],L.prototype,"lodFactor",null),(0,h._)([(0,b.Cb)()],L.prototype,"useTileCount",null),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"updating",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"running",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"updatingTotal",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"updatingRemaining",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"expectedFeatureDiff",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"memoryForUnusedFeatures",null),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,h._)([(0,b.Cb)({constructOnly:!0})],L.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"totalVertices",null),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"totalFeatures",null),(0,h._)([(0,b.Cb)()],L.prototype,"filterExtent",null),(0,h._)([(0,b.Cb)({constructOnly:!0})],L.prototype,"context",void 0),L=(0,h._)([(0,C.j)(N)],L);var W=2e3,B=(0,x.Ue)(),Y=(0,x.Ue)(),X=6e5,J=200},26511:function(e,t,i){i.d(t,{n:function(){return C}});var r=i(74165),n=i(15861),a=i(15671),s=i(43144),u=i(60136),o=i(29388),l=i(27366),c=i(14921),h=i(41691),d=i(32718),p=i(92026),f=i(66978),y=i(94172),_=i(49861),v=(i(25243),i(63780),i(69912)),m=i(18661),g=i(87072),b=i(82607),F=i(93463),C=function(e){(0,u.Z)(i,e);var t=(0,o.Z)(i);function i(e){var s;return(0,a.Z)(this,i),(s=t.call(this,e))._updateTask=null,s._frameTask=null,s._queryEngine=null,s._updateRequested=!0,s._updateVisibility=function(){var e=(0,n.Z)((0,r.Z)().mark((function e(t){var i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((0,p.Wi)(s._compositedFeatureFilter)&&(0,p.Wi)(s._sceneFilter)||0===s.context.getFeatureCount())){e.next=2;break}return e.abrupt("return",s._frameTask.schedule((function(){return s.clear()}),t));case 2:return e.prev=2,e.next=5,s._queryEngine.executeQueryForIdSet(s._compositedFeatureFilter,s._sceneFilter,t);case 5:return i=e.sent,e.abrupt("return",s._frameTask.schedule((function(){s.context.updateFeatureVisibilities((function(e){return i.has(e)}))}),t));case 9:return e.prev=9,e.t0=e.catch(2),e.abrupt("return",((0,f.r9)(e.t0),d.Z.getLogger(s.declaredClass).warn("FeatureFilter query failed: ".concat(e.t0),{error:e.t0}),s._frameTask.schedule((function(){s.context.setAllFeaturesVisibility(!0)}),t)));case 12:case"end":return e.stop()}}),e,null,[[2,9]])})));return function(t){return e.apply(this,arguments)}}(),s}return(0,s.Z)(i,[{key:"initialize",value:function(){var e=this,t=F.T8.FILTER_VISIBILITY,i=this._layerView,r=i.layer,n=i.view,a=this.context.featureStore,s="hasZ"in this._layerView&&this._layerView.hasZ,u="hasM"in this._layerView&&this._layerView.hasM;this._queryEngine=new b.q({context:{spatialReference:n.spatialReference,layer:r,scheduler:n.resourceController.scheduler,featureStore:a,hasM:u,hasZ:s},priority:t}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(t,this),this.updatingHandles.add((function(){return[e._compositedFeatureFilter,e._sceneFilter]}),(function(){return e.reapply()}),y.nn)}},{key:"destroy",value:function(){this._updateRequested=!1,this.handles.removeAll(),this.updatingHandles.removeAll(),this.clear(),this._updateTask=(0,p.IM)(this._updateTask),this._frameTask=(0,p.hw)(this._frameTask),this._queryEngine=(0,p.SC)(this._queryEngine),this._set("context",null)}},{key:"updating",get:function(){return this.running||this.updatingHandles.updating||(0,p.pC)(this._updateTask)&&!this._updateTask.finished}},{key:"running",get:function(){return this._updateRequested||this._frameTask.updating}},{key:"defaultVisibility",get:function(){return(0,p.Wi)(this._compositedFeatureFilter)&&(0,p.Wi)(this._sceneFilter)}},{key:"_featureFilter",get:function(){return"filter"in this._layerView?this._layerView.filter:null}},{key:"_sceneFilter",get:function(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}},{key:"_floorFilter",get:function(){return(0,g.c)(this._layerView)}},{key:"_timeExtent",get:function(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}},{key:"_compositedFeatureFilter",get:function(){var e=this._featureFilter,t=this._timeExtent,i=this._floorFilter;if((0,p.Wi)(t)&&(0,p.Wi)(i))return e;var r=(0,p.pC)(e)?e.clone():new m.Z;if((0,p.pC)(t)&&(r.timeExtent=(0,p.pC)(r.timeExtent)?r.timeExtent.intersection(t):t),(0,p.pC)(i)){var n=(0,p.Wi)(r.where)||""===r.where;r.where=n?i:"(".concat(r.where,") AND (").concat(i,")")}return r}},{key:"_layerView",get:function(){return this.context.layerView}},{key:"reapply",value:function(){this._updateRequested=!0}},{key:"clear",value:function(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}},{key:"runTask",value:function(e){this._updateRequested&&(this._updateTask=(0,p.IM)(this._updateTask),this._updateTask=(0,c.vr)(this._updateVisibility),this._updateRequested=!1,e.madeProgress()),this._frameTask.processQueue(e)}}]),i}(h.r);(0,l._)([(0,_.Cb)({constructOnly:!0})],C.prototype,"context",void 0),(0,l._)([(0,_.Cb)()],C.prototype,"updating",null),(0,l._)([(0,_.Cb)()],C.prototype,"running",null),(0,l._)([(0,_.Cb)()],C.prototype,"defaultVisibility",null),(0,l._)([(0,_.Cb)()],C.prototype,"_featureFilter",null),(0,l._)([(0,_.Cb)()],C.prototype,"_sceneFilter",null),(0,l._)([(0,_.Cb)()],C.prototype,"_floorFilter",null),(0,l._)([(0,_.Cb)()],C.prototype,"_timeExtent",null),(0,l._)([(0,_.Cb)()],C.prototype,"_compositedFeatureFilter",null),(0,l._)([(0,_.Cb)()],C.prototype,"_layerView",null),(0,l._)([(0,_.Cb)()],C.prototype,"_updateTask",void 0),(0,l._)([(0,_.Cb)()],C.prototype,"_updateRequested",void 0),C=(0,l._)([(0,v.j)("esri.views.3d.layers.support.FeatureVisibilityFilter")],C)},99879:function(e,t,i){function r(e,t,i){if(!i||null==t)return null;if(!e)return function(e,t){var i=t.toLowerCase();for(var r in e)if(r.toLowerCase()===i)return e[r];return null}(t,i);var r=e.get(i);return r?t[r.name]:null}i.d(t,{g:function(){return r}})},5198:function(e,t,i){i.d(t,{g:function(){return d}});var r=i(93433),n=i(37762),a=i(15671),s=i(43144),u=i(60136),o=i(29388),l=i(91505),c=i(62314),h=i(92377),d=function(e){(0,u.Z)(i,e);var t=(0,o.Z)(i);function i(){var e;return(0,a.Z)(this,i),(e=t.apply(this,arguments))._set=new Set,e}return(0,s.Z)(i,[{key:"clear",value:function(){if(this._set.size>0){var e=this.toArray();this._set.clear(),this.emit("after-changes",{type:c.y.REMOVE}),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._set.size}},{key:"addMany",value:function(e){if(0!==e.length){var t,i=(0,n.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._set.add(r)}}catch(a){i.e(a)}finally{i.f()}this.emit("after-changes",{type:c.y.ADD}),this.emit("change",{added:e,removed:[]})}}},{key:"remove",value:function(e){this._set.delete(e)&&(this.emit("after-changes",{type:c.y.REMOVE}),this.emit("change",{added:[],removed:[e]}))}},{key:"removeMany",value:function(e){var t,i=[],r=(0,n.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;this._set.delete(a)&&i.push(a)}}catch(s){r.e(s)}finally{r.f()}i.length>0&&(this.emit("after-changes",{type:c.y.REMOVE}),this.emit("change",{added:[],removed:i}))}},{key:"toArray",value:function(){return(0,r.Z)(this._set)}},{key:"find",value:function(e){var t;return(0,h.f)(this._set,(function(i){return!!e(i)&&(t=i,!0)})),t}},{key:"forEach",value:function(e){this._set.forEach((function(t){return e(t)}))}}]),i}(l.Z)},34552:function(e,t,i){i.d(t,{v:function(){return s}});var r=i(10064),n=i(92026),a=i(8548);function s(e,t){var i=e.capabilities,s=i.textureFloat,u=i.colorBufferFloat,o=null===s||void 0===s?void 0:s.textureFloat,l=null===s||void 0===s?void 0:s.textureFloatLinear,c=null===s||void 0===s?void 0:s.textureHalfFloat,h=null===s||void 0===s?void 0:s.textureHalfFloatLinear,d=null===s||void 0===s?void 0:s.HALF_FLOAT,p=null===u||void 0===u?void 0:u.textureFloat,f=null===u||void 0===u?void 0:u.textureHalfFloat,y=null===u||void 0===u?void 0:u.floatBlend,_=(0,n.s3)(e.driverTest).floatBufferBlend.result;if(!o&&!c)throw new r.Z("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float or OES_texture_half_float.");if(!p&&!f)throw new r.Z("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(y&&_||f))throw new r.Z("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(_?"":" This device claims support for EXT_float_blend, but does not actually support it."));var v=o&&p&&y&&_,m=c&&f,g=l,b=h,F=!(null===u||void 0===u||!u.R32F),C=!(null===u||void 0===u||!u.R16F);if(v&&(g||!b))return g||t.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),{dataType:a.Br.FLOAT,samplingMode:g?a.cw.LINEAR:a.cw.NEAREST,pixelFormat:F?a.VI.RED:a.VI.RGBA,internalFormat:F?a.lP.R32F:a.VI.RGBA};if(m)return b||t.warnOnce("Missing WebGL extension OES_texture_half_float_linear. Heatmap quality may be reduced."),{dataType:d,samplingMode:b?a.cw.LINEAR:a.cw.NEAREST,pixelFormat:C?a.VI.RED:a.VI.RGBA,internalFormat:C?a.lP.R16F:a.VI.RGBA};throw new r.Z("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}}}]);
//# sourceMappingURL=188.0f15a7cf.chunk.js.map